/*
 * stable-webrtc: A production-grade WebRTC library for Node.js & Browsers
 * Copyright 2025 colocohen
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at:
 *
 *     https://www.apache.org/licenses/LICENSE-2.0
 *
 * This file is part of the open-source project hosted at:
 *     https://github.com/colocohen/stable-webrtc
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 */

!function(e,t){"object"==typeof module&&module.exports?module.exports=t():e.StableWebRTC=t()}(this,(function(){var e=function(){this.Diff_Timeout=1,this.Diff_EditCost=4,this.Match_Threshold=.5,this.Match_Distance=1e3,this.Patch_DeleteThreshold=.5,this.Patch_Margin=4,this.Match_MaxBits=32},t=-1;(e.Diff=function(e,t){this[0]=e,this[1]=t}).prototype.length=2,e.Diff.prototype.toString=function(){return this[0]+","+this[1]},e.prototype.diff_main=function(t,n,i,r){if(void 0===r&&(r=0>=this.Diff_Timeout?Number.MAX_VALUE:(new Date).getTime()+1e3*this.Diff_Timeout),null==t||null==n)throw Error("Null input. (diff_main)");if(t==n)return t?[new e.Diff(0,t)]:[];void 0===i&&(i=!0);var a=i,o=this.diff_commonPrefix(t,n);i=t.substring(0,o),t=t.substring(o),n=n.substring(o),o=this.diff_commonSuffix(t,n);var l=t.substring(t.length-o);return t=t.substring(0,t.length-o),n=n.substring(0,n.length-o),t=this.diff_compute_(t,n,a,r),i&&t.unshift(new e.Diff(0,i)),l&&t.push(new e.Diff(0,l)),this.diff_cleanupMerge(t),t},e.prototype.diff_compute_=function(n,i,r,a){if(!n)return[new e.Diff(1,i)];if(!i)return[new e.Diff(t,n)];var o=n.length>i.length?n:i,l=n.length>i.length?i:n,s=o.indexOf(l);return-1!=s?(r=[new e.Diff(1,o.substring(0,s)),new e.Diff(0,l),new e.Diff(1,o.substring(s+l.length))],n.length>i.length&&(r[0][0]=r[2][0]=t),r):1==l.length?[new e.Diff(t,n),new e.Diff(1,i)]:(o=this.diff_halfMatch_(n,i))?(i=o[1],l=o[3],n=o[4],o=this.diff_main(o[0],o[2],r,a),r=this.diff_main(i,l,r,a),o.concat([new e.Diff(0,n)],r)):r&&100<n.length&&100<i.length?this.diff_lineMode_(n,i,a):this.diff_bisect_(n,i,a)},e.prototype.diff_lineMode_=function(n,i,r){var a=this.diff_linesToChars_(n,i);n=a.chars1,i=a.chars2,a=a.lineArray,n=this.diff_main(n,i,!1,r),this.diff_charsToLines_(n,a),this.diff_cleanupSemantic(n),n.push(new e.Diff(0,""));for(var o=a=i=0,l="",s="";i<n.length;){switch(n[i][0]){case 1:o++,s+=n[i][1];break;case t:a++,l+=n[i][1];break;case 0:if(1<=a&&1<=o){for(n.splice(i-a-o,a+o),i=i-a-o,o=(a=this.diff_main(l,s,!1,r)).length-1;0<=o;o--)n.splice(i,0,a[o]);i+=a.length}a=o=0,s=l=""}i++}return n.pop(),n},e.prototype.diff_bisect_=function(n,i,r){for(var a=n.length,o=i.length,l=Math.ceil((a+o)/2),s=2*l,c=Array(s),d=Array(s),_=0;_<s;_++)c[_]=-1,d[_]=-1;c[l+1]=0,d[l+1]=0;for(var f=0!=(_=a-o)%2,u=0,p=0,h=0,g=0,m=0;m<l&&!((new Date).getTime()>r);m++){for(var v=-m+u;v<=m-p;v+=2){for(var y=l+v,b=v==-m||v!=m&&c[y-1]<c[y+1]?c[y+1]:c[y-1]+1,w=b-v;b<a&&w<o&&n.charAt(b)==i.charAt(w);)b++,w++;if(c[y]=b,b>a)p+=2;else if(w>o)u+=2;else if(f&&(0<=(y=l+_-v)&&y<s&&-1!=d[y])){var k=a-d[y];if(b>=k)return this.diff_bisectSplit_(n,i,b,w,r)}}for(v=-m+h;v<=m-g;v+=2){for(y=l+v,b=(k=v==-m||v!=m&&d[y-1]<d[y+1]?d[y+1]:d[y-1]+1)-v;k<a&&b<o&&n.charAt(a-k-1)==i.charAt(o-b-1);)k++,b++;if(d[y]=k,k>a)g+=2;else if(b>o)h+=2;else if(!f&&(0<=(y=l+_-v)&&y<s&&-1!=c[y]&&(w=l+(b=c[y])-y,b>=(k=a-k))))return this.diff_bisectSplit_(n,i,b,w,r)}}return[new e.Diff(t,n),new e.Diff(1,i)]},e.prototype.diff_bisectSplit_=function(e,t,n,i,r){var a=e.substring(0,n),o=t.substring(0,i);return e=e.substring(n),t=t.substring(i),a=this.diff_main(a,o,!1,r),r=this.diff_main(e,t,!1,r),a.concat(r)},e.prototype.diff_linesToChars_=function(e,t){function n(e){for(var t="",n=0,o=-1,l=i.length;o<e.length-1;){-1==(o=e.indexOf("\n",n))&&(o=e.length-1);var s=e.substring(n,o+1);(r.hasOwnProperty?r.hasOwnProperty(s):void 0!==r[s])?t+=String.fromCharCode(r[s]):(l==a&&(s=e.substring(n),o=e.length),t+=String.fromCharCode(l),r[s]=l,i[l++]=s),n=o+1}return t}var i=[],r={};i[0]="";var a=4e4,o=n(e);return a=65535,{chars1:o,chars2:n(t),lineArray:i}},e.prototype.diff_charsToLines_=function(e,t){for(var n=0;n<e.length;n++){for(var i=e[n][1],r=[],a=0;a<i.length;a++)r[a]=t[i.charCodeAt(a)];e[n][1]=r.join("")}},e.prototype.diff_commonPrefix=function(e,t){if(!e||!t||e.charAt(0)!=t.charAt(0))return 0;for(var n=0,i=Math.min(e.length,t.length),r=i,a=0;n<r;)e.substring(a,r)==t.substring(a,r)?a=n=r:i=r,r=Math.floor((i-n)/2+n);return r},e.prototype.diff_commonSuffix=function(e,t){if(!e||!t||e.charAt(e.length-1)!=t.charAt(t.length-1))return 0;for(var n=0,i=Math.min(e.length,t.length),r=i,a=0;n<r;)e.substring(e.length-r,e.length-a)==t.substring(t.length-r,t.length-a)?a=n=r:i=r,r=Math.floor((i-n)/2+n);return r},e.prototype.diff_commonOverlap_=function(e,t){var n=e.length,i=t.length;if(0==n||0==i)return 0;if(n>i?e=e.substring(n-i):n<i&&(t=t.substring(0,n)),n=Math.min(n,i),e==t)return n;i=0;for(var r=1;;){var a=e.substring(n-r);if(-1==(a=t.indexOf(a)))return i;r+=a,0!=a&&e.substring(n-r)!=t.substring(0,r)||(i=r,r++)}},e.prototype.diff_halfMatch_=function(e,t){function n(e,t,n){for(var i,r,o,l,s=e.substring(n,n+Math.floor(e.length/4)),c=-1,d="";-1!=(c=t.indexOf(s,c+1));){var _=a.diff_commonPrefix(e.substring(n),t.substring(c)),f=a.diff_commonSuffix(e.substring(0,n),t.substring(0,c));d.length<f+_&&(d=t.substring(c-f,c)+t.substring(c,c+_),i=e.substring(0,n-f),r=e.substring(n+_),o=t.substring(0,c-f),l=t.substring(c+_))}return 2*d.length>=e.length?[i,r,o,l,d]:null}if(0>=this.Diff_Timeout)return null;var i=e.length>t.length?e:t,r=e.length>t.length?t:e;if(4>i.length||2*r.length<i.length)return null;var a=this,o=n(i,r,Math.ceil(i.length/4));if(i=n(i,r,Math.ceil(i.length/2)),!o&&!i)return null;if(o=i?o&&o[4].length>i[4].length?o:i:o,e.length>t.length){i=o[0],r=o[1];var l=o[2],s=o[3]}else l=o[0],s=o[1],i=o[2],r=o[3];return[i,r,l,s,o[4]]},e.prototype.diff_cleanupSemantic=function(n){for(var i=!1,r=[],a=0,o=null,l=0,s=0,c=0,d=0,_=0;l<n.length;)0==n[l][0]?(r[a++]=l,s=d,c=_,_=d=0,o=n[l][1]):(1==n[l][0]?d+=n[l][1].length:_+=n[l][1].length,o&&o.length<=Math.max(s,c)&&o.length<=Math.max(d,_)&&(n.splice(r[a-1],0,new e.Diff(t,o)),n[r[a-1]+1][0]=1,a--,l=0<--a?r[a-1]:-1,_=d=c=s=0,o=null,i=!0)),l++;for(i&&this.diff_cleanupMerge(n),this.diff_cleanupSemanticLossless(n),l=1;l<n.length;)n[l-1][0]==t&&1==n[l][0]&&(i=n[l-1][1],r=n[l][1],(a=this.diff_commonOverlap_(i,r))>=(o=this.diff_commonOverlap_(r,i))?(a>=i.length/2||a>=r.length/2)&&(n.splice(l,0,new e.Diff(0,r.substring(0,a))),n[l-1][1]=i.substring(0,i.length-a),n[l+1][1]=r.substring(a),l++):(o>=i.length/2||o>=r.length/2)&&(n.splice(l,0,new e.Diff(0,i.substring(0,o))),n[l-1][0]=1,n[l-1][1]=r.substring(0,r.length-o),n[l+1][0]=t,n[l+1][1]=i.substring(o),l++),l++),l++},e.prototype.diff_cleanupSemanticLossless=function(t){function n(t,n){if(!t||!n)return 6;var i=t.charAt(t.length-1),r=n.charAt(0),a=i.match(e.nonAlphaNumericRegex_),o=r.match(e.nonAlphaNumericRegex_),l=a&&i.match(e.whitespaceRegex_),s=o&&r.match(e.whitespaceRegex_);i=l&&i.match(e.linebreakRegex_),r=s&&r.match(e.linebreakRegex_);var c=i&&t.match(e.blanklineEndRegex_),d=r&&n.match(e.blanklineStartRegex_);return c||d?5:i||r?4:a&&!l&&s?3:l||s?2:a||o?1:0}for(var i=1;i<t.length-1;){if(0==t[i-1][0]&&0==t[i+1][0]){var r=t[i-1][1],a=t[i][1],o=t[i+1][1],l=this.diff_commonSuffix(r,a);if(l){var s=a.substring(a.length-l);r=r.substring(0,r.length-l),a=s+a.substring(0,a.length-l),o=s+o}l=r,s=a;for(var c=o,d=n(r,a)+n(a,o);a.charAt(0)===o.charAt(0);){r+=a.charAt(0),a=a.substring(1)+o.charAt(0),o=o.substring(1);var _=n(r,a)+n(a,o);_>=d&&(d=_,l=r,s=a,c=o)}t[i-1][1]!=l&&(l?t[i-1][1]=l:(t.splice(i-1,1),i--),t[i][1]=s,c?t[i+1][1]=c:(t.splice(i+1,1),i--))}i++}},e.nonAlphaNumericRegex_=/[^a-zA-Z0-9]/,e.whitespaceRegex_=/\s/,e.linebreakRegex_=/[\r\n]/,e.blanklineEndRegex_=/\n\r?\n$/,e.blanklineStartRegex_=/^\r?\n\r?\n/,e.prototype.diff_cleanupEfficiency=function(n){for(var i=!1,r=[],a=0,o=null,l=0,s=!1,c=!1,d=!1,_=!1;l<n.length;)0==n[l][0]?(n[l][1].length<this.Diff_EditCost&&(d||_)?(r[a++]=l,s=d,c=_,o=n[l][1]):(a=0,o=null),d=_=!1):(n[l][0]==t?_=!0:d=!0,o&&(s&&c&&d&&_||o.length<this.Diff_EditCost/2&&3==s+c+d+_)&&(n.splice(r[a-1],0,new e.Diff(t,o)),n[r[a-1]+1][0]=1,a--,o=null,s&&c?(d=_=!0,a=0):(l=0<--a?r[a-1]:-1,d=_=!1),i=!0)),l++;i&&this.diff_cleanupMerge(n)},e.prototype.diff_cleanupMerge=function(n){n.push(new e.Diff(0,""));for(var i,r=0,a=0,o=0,l="",s="";r<n.length;)switch(n[r][0]){case 1:o++,s+=n[r][1],r++;break;case t:a++,l+=n[r][1],r++;break;case 0:1<a+o?(0!==a&&0!==o&&(0!==(i=this.diff_commonPrefix(s,l))&&(0<r-a-o&&0==n[r-a-o-1][0]?n[r-a-o-1][1]+=s.substring(0,i):(n.splice(0,0,new e.Diff(0,s.substring(0,i))),r++),s=s.substring(i),l=l.substring(i)),0!==(i=this.diff_commonSuffix(s,l))&&(n[r][1]=s.substring(s.length-i)+n[r][1],s=s.substring(0,s.length-i),l=l.substring(0,l.length-i))),r-=a+o,n.splice(r,a+o),l.length&&(n.splice(r,0,new e.Diff(t,l)),r++),s.length&&(n.splice(r,0,new e.Diff(1,s)),r++),r++):0!==r&&0==n[r-1][0]?(n[r-1][1]+=n[r][1],n.splice(r,1)):r++,a=o=0,s=l=""}for(""===n[n.length-1][1]&&n.pop(),a=!1,r=1;r<n.length-1;)0==n[r-1][0]&&0==n[r+1][0]&&(n[r][1].substring(n[r][1].length-n[r-1][1].length)==n[r-1][1]?(n[r][1]=n[r-1][1]+n[r][1].substring(0,n[r][1].length-n[r-1][1].length),n[r+1][1]=n[r-1][1]+n[r+1][1],n.splice(r-1,1),a=!0):n[r][1].substring(0,n[r+1][1].length)==n[r+1][1]&&(n[r-1][1]+=n[r+1][1],n[r][1]=n[r][1].substring(n[r+1][1].length)+n[r+1][1],n.splice(r+1,1),a=!0)),r++;a&&this.diff_cleanupMerge(n)},e.prototype.diff_xIndex=function(e,n){var i,r=0,a=0,o=0,l=0;for(i=0;i<e.length&&(1!==e[i][0]&&(r+=e[i][1].length),e[i][0]!==t&&(a+=e[i][1].length),!(r>n));i++)o=r,l=a;return e.length!=i&&e[i][0]===t?l:l+(n-o)},e.prototype.diff_prettyHtml=function(e){for(var n=[],i=/&/g,r=/</g,a=/>/g,o=/\n/g,l=0;l<e.length;l++){var s=e[l][0],c=e[l][1].replace(i,"&amp;").replace(r,"&lt;").replace(a,"&gt;").replace(o,"&para;<br>");switch(s){case 1:n[l]='<ins style="background:#e6ffe6;">'+c+"</ins>";break;case t:n[l]='<del style="background:#ffe6e6;">'+c+"</del>";break;case 0:n[l]="<span>"+c+"</span>"}}return n.join("")},e.prototype.diff_text1=function(e){for(var t=[],n=0;n<e.length;n++)1!==e[n][0]&&(t[n]=e[n][1]);return t.join("")},e.prototype.diff_text2=function(e){for(var n=[],i=0;i<e.length;i++)e[i][0]!==t&&(n[i]=e[i][1]);return n.join("")},e.prototype.diff_levenshtein=function(e){for(var n=0,i=0,r=0,a=0;a<e.length;a++){var o=e[a][1];switch(e[a][0]){case 1:i+=o.length;break;case t:r+=o.length;break;case 0:n+=Math.max(i,r),r=i=0}}return n+Math.max(i,r)},e.prototype.diff_toDelta=function(e){for(var n=[],i=0;i<e.length;i++)switch(e[i][0]){case 1:n[i]="+"+encodeURI(e[i][1]);break;case t:n[i]="-"+e[i][1].length;break;case 0:n[i]="="+e[i][1].length}return n.join("\t").replace(/%20/g," ")},e.prototype.diff_fromDelta=function(n,i){for(var r=[],a=0,o=0,l=i.split(/\t/g),s=0;s<l.length;s++){var c=l[s].substring(1);switch(l[s].charAt(0)){case"+":try{r[a++]=new e.Diff(1,decodeURI(c))}catch(e){throw Error("Illegal escape in diff_fromDelta: "+c)}break;case"-":case"=":var d=parseInt(c,10);if(isNaN(d)||0>d)throw Error("Invalid number in diff_fromDelta: "+c);c=n.substring(o,o+=d),"="==l[s].charAt(0)?r[a++]=new e.Diff(0,c):r[a++]=new e.Diff(t,c);break;default:if(l[s])throw Error("Invalid diff operation in diff_fromDelta: "+l[s])}}if(o!=n.length)throw Error("Delta length ("+o+") does not equal source text length ("+n.length+").");return r},e.prototype.match_main=function(e,t,n){if(null==e||null==t||null==n)throw Error("Null input. (match_main)");return n=Math.max(0,Math.min(n,e.length)),e==t?0:e.length?e.substring(n,n+t.length)==t?n:this.match_bitap_(e,t,n):-1},e.prototype.match_bitap_=function(e,t,n){function i(e,i){var r=e/t.length,o=Math.abs(n-i);return a.Match_Distance?r+o/a.Match_Distance:o?1:r}if(t.length>this.Match_MaxBits)throw Error("Pattern too long for this browser.");var r=this.match_alphabet_(t),a=this,o=this.Match_Threshold,l=e.indexOf(t,n);-1!=l&&(o=Math.min(i(0,l),o),-1!=(l=e.lastIndexOf(t,n+t.length))&&(o=Math.min(i(0,l),o)));var s=1<<t.length-1;l=-1;for(var c,d,_,f=t.length+e.length,u=0;u<t.length;u++){for(c=0,d=f;c<d;)i(u,n+d)<=o?c=d:f=d,d=Math.floor((f-c)/2+c);f=d,c=Math.max(1,n-d+1);var p=Math.min(n+d,e.length)+t.length;for((d=Array(p+2))[p+1]=(1<<u)-1;p>=c;p--){var h=r[e.charAt(p-1)];if(d[p]=0===u?(d[p+1]<<1|1)&h:(d[p+1]<<1|1)&h|(_[p+1]|_[p])<<1|1|_[p+1],d[p]&s&&(h=i(u,p-1))<=o){if(o=h,!((l=p-1)>n))break;c=Math.max(1,2*n-l)}}if(i(u+1,n)>o)break;_=d}return l},e.prototype.match_alphabet_=function(e){for(var t={},n=0;n<e.length;n++)t[e.charAt(n)]=0;for(n=0;n<e.length;n++)t[e.charAt(n)]|=1<<e.length-n-1;return t},e.prototype.patch_addContext_=function(t,n){if(0!=n.length){if(null===t.start2)throw Error("patch not initialized");for(var i=n.substring(t.start2,t.start2+t.length1),r=0;n.indexOf(i)!=n.lastIndexOf(i)&&i.length<this.Match_MaxBits-this.Patch_Margin-this.Patch_Margin;)r+=this.Patch_Margin,i=n.substring(t.start2-r,t.start2+t.length1+r);r+=this.Patch_Margin,(i=n.substring(t.start2-r,t.start2))&&t.diffs.unshift(new e.Diff(0,i)),(r=n.substring(t.start2+t.length1,t.start2+t.length1+r))&&t.diffs.push(new e.Diff(0,r)),t.start1-=i.length,t.start2-=i.length,t.length1+=i.length+r.length,t.length2+=i.length+r.length}},e.prototype.patch_make=function(n,i,r){if("string"==typeof n&&"string"==typeof i&&void 0===r){var a=n;2<(i=this.diff_main(a,i,!0)).length&&(this.diff_cleanupSemantic(i),this.diff_cleanupEfficiency(i))}else if(n&&"object"==typeof n&&void 0===i&&void 0===r)i=n,a=this.diff_text1(i);else if("string"==typeof n&&i&&"object"==typeof i&&void 0===r)a=n;else{if("string"!=typeof n||"string"!=typeof i||!r||"object"!=typeof r)throw Error("Unknown call format to patch_make.");a=n,i=r}if(0===i.length)return[];r=[],n=new e.patch_obj;for(var o=0,l=0,s=0,c=a,d=0;d<i.length;d++){var _=i[d][0],f=i[d][1];switch(o||0===_||(n.start1=l,n.start2=s),_){case 1:n.diffs[o++]=i[d],n.length2+=f.length,a=a.substring(0,s)+f+a.substring(s);break;case t:n.length1+=f.length,n.diffs[o++]=i[d],a=a.substring(0,s)+a.substring(s+f.length);break;case 0:f.length<=2*this.Patch_Margin&&o&&i.length!=d+1?(n.diffs[o++]=i[d],n.length1+=f.length,n.length2+=f.length):f.length>=2*this.Patch_Margin&&o&&(this.patch_addContext_(n,c),r.push(n),n=new e.patch_obj,o=0,c=a,l=s)}1!==_&&(l+=f.length),_!==t&&(s+=f.length)}return o&&(this.patch_addContext_(n,c),r.push(n)),r},e.prototype.patch_deepCopy=function(t){for(var n=[],i=0;i<t.length;i++){var r=t[i],a=new e.patch_obj;a.diffs=[];for(var o=0;o<r.diffs.length;o++)a.diffs[o]=new e.Diff(r.diffs[o][0],r.diffs[o][1]);a.start1=r.start1,a.start2=r.start2,a.length1=r.length1,a.length2=r.length2,n[i]=a}return n},e.prototype.patch_apply=function(e,n){if(0==e.length)return[n,[]];e=this.patch_deepCopy(e);var i=this.patch_addPadding(e);n=i+n+i,this.patch_splitMax(e);for(var r=0,a=[],o=0;o<e.length;o++){var l=e[o].start2+r,s=this.diff_text1(e[o].diffs),c=-1;if(s.length>this.Match_MaxBits){var d=this.match_main(n,s.substring(0,this.Match_MaxBits),l);-1!=d&&(-1==(c=this.match_main(n,s.substring(s.length-this.Match_MaxBits),l+s.length-this.Match_MaxBits))||d>=c)&&(d=-1)}else d=this.match_main(n,s,l);if(-1==d)a[o]=!1,r-=e[o].length2-e[o].length1;else if(a[o]=!0,r=d-l,s==(l=-1==c?n.substring(d,d+s.length):n.substring(d,c+this.Match_MaxBits)))n=n.substring(0,d)+this.diff_text2(e[o].diffs)+n.substring(d+s.length);else if(l=this.diff_main(s,l,!1),s.length>this.Match_MaxBits&&this.diff_levenshtein(l)/s.length>this.Patch_DeleteThreshold)a[o]=!1;else{var _;for(this.diff_cleanupSemanticLossless(l),s=0,c=0;c<e[o].diffs.length;c++){var f=e[o].diffs[c];0!==f[0]&&(_=this.diff_xIndex(l,s)),1===f[0]?n=n.substring(0,d+_)+f[1]+n.substring(d+_):f[0]===t&&(n=n.substring(0,d+_)+n.substring(d+this.diff_xIndex(l,s+f[1].length))),f[0]!==t&&(s+=f[1].length)}}}return[n=n.substring(i.length,n.length-i.length),a]},e.prototype.patch_addPadding=function(t){for(var n=this.Patch_Margin,i="",r=1;r<=n;r++)i+=String.fromCharCode(r);for(r=0;r<t.length;r++)t[r].start1+=n,t[r].start2+=n;var a=(r=t[0]).diffs;if(0==a.length||0!=a[0][0])a.unshift(new e.Diff(0,i)),r.start1-=n,r.start2-=n,r.length1+=n,r.length2+=n;else if(n>a[0][1].length){var o=n-a[0][1].length;a[0][1]=i.substring(a[0][1].length)+a[0][1],r.start1-=o,r.start2-=o,r.length1+=o,r.length2+=o}return 0==(a=(r=t[t.length-1]).diffs).length||0!=a[a.length-1][0]?(a.push(new e.Diff(0,i)),r.length1+=n,r.length2+=n):n>a[a.length-1][1].length&&(o=n-a[a.length-1][1].length,a[a.length-1][1]+=i.substring(0,o),r.length1+=o,r.length2+=o),i},e.prototype.patch_splitMax=function(n){for(var i=this.Match_MaxBits,r=0;r<n.length;r++)if(!(n[r].length1<=i)){var a=n[r];n.splice(r--,1);for(var o=a.start1,l=a.start2,s="";0!==a.diffs.length;){var c=new e.patch_obj,d=!0;for(c.start1=o-s.length,c.start2=l-s.length,""!==s&&(c.length1=c.length2=s.length,c.diffs.push(new e.Diff(0,s)));0!==a.diffs.length&&c.length1<i-this.Patch_Margin;){s=a.diffs[0][0];var _=a.diffs[0][1];1===s?(c.length2+=_.length,l+=_.length,c.diffs.push(a.diffs.shift()),d=!1):s===t&&1==c.diffs.length&&0==c.diffs[0][0]&&_.length>2*i?(c.length1+=_.length,o+=_.length,d=!1,c.diffs.push(new e.Diff(s,_)),a.diffs.shift()):(_=_.substring(0,i-c.length1-this.Patch_Margin),c.length1+=_.length,o+=_.length,0===s?(c.length2+=_.length,l+=_.length):d=!1,c.diffs.push(new e.Diff(s,_)),_==a.diffs[0][1]?a.diffs.shift():a.diffs[0][1]=a.diffs[0][1].substring(_.length))}s=(s=this.diff_text2(c.diffs)).substring(s.length-this.Patch_Margin),""!==(_=this.diff_text1(a.diffs).substring(0,this.Patch_Margin))&&(c.length1+=_.length,c.length2+=_.length,0!==c.diffs.length&&0===c.diffs[c.diffs.length-1][0]?c.diffs[c.diffs.length-1][1]+=_:c.diffs.push(new e.Diff(0,_))),d||n.splice(++r,0,c)}}},e.prototype.patch_toText=function(e){for(var t=[],n=0;n<e.length;n++)t[n]=e[n];return t.join("")},e.prototype.patch_fromText=function(n){var i=[];if(!n)return i;n=n.split("\n");for(var r=0,a=/^@@ -(\d+),?(\d*) \+(\d+),?(\d*) @@$/;r<n.length;){var o=n[r].match(a);if(!o)throw Error("Invalid patch string: "+n[r]);var l=new e.patch_obj;for(i.push(l),l.start1=parseInt(o[1],10),""===o[2]?(l.start1--,l.length1=1):"0"==o[2]?l.length1=0:(l.start1--,l.length1=parseInt(o[2],10)),l.start2=parseInt(o[3],10),""===o[4]?(l.start2--,l.length2=1):"0"==o[4]?l.length2=0:(l.start2--,l.length2=parseInt(o[4],10)),r++;r<n.length;){o=n[r].charAt(0);try{var s=decodeURI(n[r].substring(1))}catch(e){throw Error("Illegal escape in patch_fromText: "+s)}if("-"==o)l.diffs.push(new e.Diff(t,s));else if("+"==o)l.diffs.push(new e.Diff(1,s));else if(" "==o)l.diffs.push(new e.Diff(0,s));else{if("@"==o)break;if(""!==o)throw Error('Invalid patch mode "'+o+'" in: '+s)}r++}}return i},(e.patch_obj=function(){this.diffs=[],this.start2=this.start1=null,this.length2=this.length1=0}).prototype.toString=function(){for(var e,n=["@@ -"+(0===this.length1?this.start1+",0":1==this.length1?this.start1+1:this.start1+1+","+this.length1)+" +"+(0===this.length2?this.start2+",0":1==this.length2?this.start2+1:this.start2+1+","+this.length2)+" @@\n"],i=0;i<this.diffs.length;i++){switch(this.diffs[i][0]){case 1:e="+";break;case t:e="-";break;case 0:e=" "}n[i+1]=e+encodeURI(this.diffs[i][1])+"\n"}return n.join("").replace(/%20/g," ")},this.diff_match_patch=e,this.DIFF_DELETE=t,this.DIFF_INSERT=1,this.DIFF_EQUAL=0;var n=new e;function i(e,t){var i=n.diff_main(e,t);n.diff_cleanupEfficiency(i);var r=n.patch_make(e,i);return n.patch_toText(r)}function r(e,t){var i=n.patch_fromText(t);return n.patch_apply(i,e)[0]}var a=null;function o(){if(!a&&"undefined"!=typeof require)try{a=require("zlib")}catch(e){a=null}return a}function l(e,t){var n=e instanceof Uint8Array?e:(new TextEncoder).encode(e);if("undefined"!=typeof CompressionStream&&"undefined"!=typeof Response)try{var i=new CompressionStream("deflate"),r=new Response(n).body.pipeThrough(i);return void new Response(r).arrayBuffer().then((function(e){t(new Uint8Array(e))})).catch((function(){t(null)}))}catch(e){}var a=o();a&&a.deflate?a.deflate(Buffer.from(n),{level:9},(function(e,n){t(e?null:new Uint8Array(n))})):t(null)}function s(e,t){var n=e instanceof Uint8Array?e:e&&null!=e.buffer&&null!=e.byteLength?new Uint8Array(e.buffer,e.byteOffset||0,e.byteLength):new Uint8Array(e||0);if("undefined"!=typeof DecompressionStream&&"undefined"!=typeof Response)try{var i=new DecompressionStream("deflate"),r=new Response(n).body.pipeThrough(i);return void new Response(r).arrayBuffer().then((function(e){t((new TextDecoder).decode(e))})).catch((function(){t(null)}))}catch(e){}var a=o();a&&a.inflate?a.inflate(Buffer.from(n),(function(e,n){t(e?null:n.toString("utf8"))})):t(null)}function c(e){return e&&"number"==typeof e.byteLength&&"number"==typeof e.BYTES_PER_ELEMENT&&e.buffer instanceof ArrayBuffer}function d(e){return null==e?new Uint8Array(0):e instanceof Uint8Array?e:e instanceof ArrayBuffer?new Uint8Array(e):ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset||0,e.byteLength||0):"string"==typeof e?(new TextEncoder).encode(e):(new TextEncoder).encode(String(e))}function _(e,t,n){var i=Number(4294967295&n),r=Number(n/4294967296>>>0);e.setUint32(t,i>>>0,!0),e.setUint32(t+4,r>>>0,!0)}var f=9007199254740991n;function u(e,t){var n=e.getUint32(t,!0),i=e.getUint32(t+4,!0),r=BigInt(i)<<32n|BigInt(n);return r<=f?Number(r):r}function p(e,t){var n,i=0;for(n=0;n<e.length;n++){if(8!==(s=e[n]>>>0)&&16!==s&&32!==s&&64!==s)throw new Error("build_structure: unsupported fixed field size: "+s);i+=s/8}var r=0;for(n=e.length;n<t.length;n++)r+=d(t[n]).byteLength;var a=new Uint8Array(i+r),o=new DataView(a.buffer),l=0;for(n=0;n<e.length;n++){var s=e[n]>>>0,c=null==t[n]?0:t[n];8===s?o.setUint8(l,!0===c?1:!1===c?0:c>>>0&255):16===s?o.setUint16(l,c>>>0,!0):32===s?o.setUint32(l,c>>>0,!0):64===s&&_(o,l,c),l+=s/8}for(;n<t.length;n++){var f=d(t[n]),u=f.byteLength;u>0&&a.set(f,l),l+=u}return a}function h(e,t,n){for(var i=c(t)||t instanceof ArrayBuffer?new Uint8Array(t):new Uint8Array(0),r=new DataView(i.buffer,i.byteOffset,i.byteLength),a=[],o=0,l=0;l<e.length;l++){var s=e[l]>>>0,d=s/8;o+d>i.byteLength?a.push(null):(8===s?a.push(Number(r.getUint8(o))):16===s?a.push(Number(r.getUint16(o,!0))):32===s?a.push(Number(r.getUint32(o,!0))):64===s?a.push(u(r,o)):a.push(null),o+=d)}for(o<i.byteLength?a.push(new Uint8Array(i.buffer,i.byteOffset+o,i.byteLength-o)):a.push(new Uint8Array(0));a.length<e.length;)a.push(null);return"function"==typeof n?n.apply(null,a):a}function g(e){var t=parseInt(e||"0",16)>>>0;return[t>>>8&255,255&t]}function m(e,t){return 6===t?function(e){var t=e||"",n=t.indexOf("%");n>=0&&(t=t.slice(0,n));var i,r=t.split("::"),a=r[0]?r[0].split(":"):[],o=r[1]?r[1].split(":"):[],l=8-(a.length+o.length),s=[];for(i=0;i<a.length;i++)s=s.concat(g(a[i]));for(i=0;i<l;i++)s.push(0,0);for(i=0;i<o.length;i++)s=s.concat(g(o[i]));return new Uint8Array(s)}(e):4===t?function(e){var t=(e||"").split("."),n=new Uint8Array(4);return n[0]=0|t[0],n[1]=0|t[1],n[2]=0|t[2],n[3]=0|t[3],n}(e):null}function v(e,t,n,i){if(!e)return new Uint8Array(0);var r,a=null!=e.component_id?0|e.component_id:null!=e.component?0|e.component:1,o=null!=e.transportNum?0|e.transportNum:(r=e.transport)&&"tcp"===r.toLowerCase()?1:0,l=null!=e.typeNum?0|e.typeNum:null!=e.candTypeNum?0|e.candTypeNum:function(e){var t=(e||"").toLowerCase();return"host"===t?0:"srflx"===t?1:"prflx"===t?2:3}(e.type||e.candType),s=e.priority>>>0||0,c=null!=e.ipFamily?0|e.ipFamily:e.isMdns?0:e.ip&&e.ip.indexOf(":")>=0?6:4,_=0===c?1:0,f=e.port>>>0||0,u=!!e.hasRel,h=u&&e.relIsMdns?1:0,g=0|e.relIpFamily||0,v=u&&e.relPort>>>0||0,y=!!e.hasTcpType,b=y?null!=e.tcpType?0|e.tcpType:function(e){var t=(e||"").toLowerCase();return"active"===t?0:"passive"===t?1:2}(e.tcpTypeStr):0,w=null!=e.generation,k=w?0|e.generation:0,T=null!=e.networkCost,x=T?e.networkCost>>>0:0,S=!!e.foundationIsNumeric,D=S?e.foundationU32>>>0:0,C=S?null:e.foundation||"",M=null==n?0|e.mlineIndex:0|n;M>=0&&M<=255||(M=0);var R=null!=t?""+t:null!=e.sdpMid?""+e.sdpMid:"",A=null!=i?""+i:null!=e.ufrag?""+e.ufrag:"",I=R&&R.length>0?1:0,P=A&&A.length>0?1:0,O=p([8,8],[3&o|(3&l)<<2|(6===c?1:0)<<4|(u?1:0)<<5|(_?1:0)<<6|(u&&h?1:0)<<7,(w?1:0)|(T?1:0)<<1|(y?1:0)<<2|(S?1:0)<<3|(I?1:0)<<4|(P?1:0)<<5]),N=[8,8,32,16],U=[255&a,255&M,s>>>0,f>>>0];y&&(N.push(8),U.push(255&b)),w&&(N.push(8),U.push(255&k)),T&&(N.push(16),U.push(65535&x)),S&&(N.push(32),U.push(D>>>0));var L=p(N,U),E=[];if(!_){var q=m(e.ip,c);q&&E.push(q)}if(u){if(!h){var B=m(e.relIp,g);B&&E.push(B)}var F=new Uint8Array(2);new DataView(F.buffer).setUint16(0,v>>>0,!0),E.push(F)}var j=[];S||j.push(C||""),_&&j.push(e.ip||""),u&&h&&j.push(e.relIp||""),I&&j.push(R||""),P&&j.push(A||"");var z=j.length>0?function(e,t){var n,i=e&&e>0?(e>>>0)/8:0;if(i){var r=i*t.length,a=new Uint8Array(r),o=0;for(n=0;n<t.length;n++){var l=d(t[n]),s=Math.min(l.length,i);s>0&&a.set(l.subarray(0,s),o),o+=i}return a}var c=0,_=new Array(t.length);for(n=0;n<t.length;n++)_[n]=d(t[n]),c+=4+_[n].length;a=new Uint8Array(c);var f=new DataView(a.buffer);for(o=0,n=0;n<_.length;n++)f.setUint32(o,_[n].length>>>0,!0),a.set(_[n],o+4),o+=4+_[n].length;return a}(0,j):new Uint8Array(0);return function(e){var t,n=0;for(t=0;t<e.length;t++)e[t]&&(n+=e[t].length);var i=new Uint8Array(n),r=0;for(t=0;t<e.length;t++)e[t]&&(i.set(e[t],r),r+=e[t].length);return i}([O,L].concat(E).concat([z]))}function y(e){if(!e||e.length<2)return null;var t=h([8,8],e=c(e)||e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(0)),n=0|t[0],i=0|t[1],r=t[2],a=3&n,o=n>>2&3,l=n>>4&1,s=n>>5&1,d=n>>6&1,_=n>>7&1,f=1&i,u=i>>1&1,p=i>>2&1,g=i>>3&1,m=i>>4&1,v=i>>5&1,y=[8,8,32,16];p&&y.push(8),f&&y.push(8),u&&y.push(16),g&&y.push(32);var b=h(y,r),w=0|b[0],k=0|b[1],T=b[2]>>>0,x=b[3]>>>0,S=4,D=0,C=null,M=null,R=null;p&&(D=0|b[S++]),f&&(C=0|b[S++]),u&&(M=b[S++]>>>0),g&&(R=b[S++]>>>0);var A=b[y.length],I=0,P=null,O=null,N=0;if(!d){var U=l?16:4;P=new Uint8Array(A.buffer,A.byteOffset+I,U),I+=U}if(s){if(!_){var L=l?16:4;O=new Uint8Array(A.buffer,A.byteOffset+I,L),I+=L}N=new DataView(A.buffer,A.byteOffset+I,2).getUint16(0,!0),I+=2}var E=function(e,t){var n=c(t)||t instanceof ArrayBuffer?new Uint8Array(t):new Uint8Array(0),i=[];if(0===n.length)return i;var r=e&&e>0?(e>>>0)/8:0;if(r){for(var a=0;a<n.length;){var o=Math.min(a+r,n.length);i.push(n.subarray(a,o)),a=o}return i}var l=new DataView(n.buffer,n.byteOffset,n.byteLength);for(a=0;a+4<=n.length;){var s=l.getUint32(a,!0)>>>0;a+=4,o=Math.min(a+s,n.length),i.push(n.subarray(a,o)),a=o}return i}(0,new Uint8Array(A.buffer,A.byteOffset+I,A.byteLength-I)).map((function(e){return String.fromCharCode.apply(null,e)})),q=0,B=null;g||(B=E[q++]||null),d&&(P=E[q++]||null),s&&_&&(O=E[q++]||null);var F=m&&E[q++]||null,j=v&&E[q++]||null,z=["host","srflx","prflx","relay"][o]||"host",J=p?0===D?"active":1===D?"passive":"so":null;function V(e){if(!e)return null;if(4===e.length)return e[0]+"."+e[1]+"."+e[2]+"."+e[3];if(16===e.length){for(var t=[],n=0;n<16;n+=2){var i=e[n]<<8|e[n+1];t.push(i.toString(16))}return t.join(":").replace(/(:0)+:/,"::")}return null}return{foundation:g?""+R:B,foundationU32:R,component_id:w,transport:1===a?"tcp":"udp",transportNum:a,priority:T,address:(d?P:V(P))||null,port:x,type:z,typeNum:o,relatedAddress:s?_?O:V(O):null,relatedPort:N,tcptype:J,generation:C,network_cost:M,sdpMid:F,sdpMLineIndex:k,ufrag:j}}function b(e){if(!e)return null;var t=function(e){var t=null!=e.foundation?String(e.foundation):"0",n=null!=e.component_id?0|e.component_id:1,i=(e.transport||"udp").toUpperCase(),r=e.priority>>>0||0,a=e.address||"0.0.0.0",o=e.port>>>0||0,l=(e.type||"host").toLowerCase(),s=["candidate:"+t,String(n),i,String(r),a,String(o),"typ",l];if("srflx"===l){var c=e.relatedAddress||"0.0.0.0",d=null!=e.relatedPort?e.relatedPort>>>0:0;s.push("raddr",c,"rport",String(d))}else e.relatedAddress&&null!=e.relatedPort&&s.push("raddr",e.relatedAddress,"rport",String(e.relatedPort>>>0));return"TCP"===i&&e.tcptype&&s.push("tcptype",e.tcptype),null!=e.generation&&s.push("generation",String(0|e.generation)),null!=e.network_id&&s.push("network-id",String(0|e.network_id)),null!=e.network_cost&&s.push("network-cost",String(e.network_cost>>>0)),s.join(" ")}(e);return{candidate:t,sdpMid:null!=e.sdpMid?String(e.sdpMid):null,sdpMLineIndex:null!=e.sdpMLineIndex?0|e.sdpMLineIndex:0,usernameFragment:e.ufrag||null}}function w(e){for(var t=String(e),n=3&t.length,i=t.length-n,r=0,a=3432918353,o=461845907,l=0,s=0;l<i;){s=255&t.charCodeAt(l)|(255&t.charCodeAt(++l))<<8|(255&t.charCodeAt(++l))<<16|(255&t.charCodeAt(++l))<<24,++l;var c=5*(65535&(r=(r^=s=(65535&(s=(s=(65535&s)*a+(((s>>>16)*a&65535)<<16)&4294967295)<<15|s>>>17))*o+(((s>>>16)*o&65535)<<16)&4294967295)<<13|r>>>19))+((5*(r>>>16)&65535)<<16)&4294967295;r=27492+(65535&c)+((58964+(c>>>16)&65535)<<16)}return s=0,3===n&&(s^=(255&t.charCodeAt(l+2))<<16),n>=2&&(s^=(255&t.charCodeAt(l+1))<<8),n>=1&&(r^=s=(65535&(s=(s=(65535&(s^=255&t.charCodeAt(l)))*a+(((s>>>16)*a&65535)<<16)&4294967295)<<15|s>>>17))*o+(((s>>>16)*o&65535)<<16)&4294967295),r^=t.length,r=2246822507*(65535&(r^=r>>>16))+((2246822507*(r>>>16)&65535)<<16)&4294967295,r=3266489909*(65535&(r^=r>>>13))+((3266489909*(r>>>16)&65535)<<16)&4294967295,(r^=r>>>16)>>>0}function k(e){for(var t=3&e.length,n=e.length-t,i=0,r=3432918353,a=461845907,o=0,l=0;o<n;){l=255&e[o]|(255&e[++o])<<8|(255&e[++o])<<16|(255&e[++o])<<24,++o;var s=5*(65535&(i=(i^=l=(65535&(l=(l=(65535&l)*r+(((l>>>16)*r&65535)<<16)&4294967295)<<15|l>>>17))*a+(((l>>>16)*a&65535)<<16)&4294967295)<<13|i>>>19))+((5*(i>>>16)&65535)<<16)&4294967295;i=27492+(65535&s)+((58964+(s>>>16)&65535)<<16)}return l=0,3===t&&(l^=(255&e[o+2])<<16),t>=2&&(l^=(255&e[o+1])<<8),t>=1&&(i^=l=(65535&(l=(l=(65535&(l^=255&e[o]))*r+(((l>>>16)*r&65535)<<16)&4294967295)<<15|l>>>17))*a+(((l>>>16)*a&65535)<<16)&4294967295),i^=e.length,i=2246822507*(65535&(i^=i>>>16))+((2246822507*(i>>>16)&65535)<<16)&4294967295,i=3266489909*(65535&(i^=i>>>13))+((3266489909*(i>>>16)&65535)<<16)&4294967295,(i^=i>>>16)>>>0}function T(e){try{if("undefined"!=typeof MediaStream&&e instanceof MediaStream)return!0}catch(e){}return!!e&&"function"==typeof e.getTracks}function x(e){try{if("undefined"!=typeof MediaStreamTrack&&e instanceof MediaStreamTrack)return!0}catch(e){}return!!e&&"function"==typeof e.stop&&"string"==typeof e.kind}function S(e,t){if(!e&&!t)return!0;if(!e||!t)return!1;if(e===t)return!0;var n="string"==typeof e.id&&""!==e.id.trim(),i="string"==typeof t.id&&""!==t.id.trim();return!(!n||!i||e.id!==t.id)}function D(e){return e&&-1!==e.indexOf(":")}function C(e){return e&&"["===e.charAt(0)&&"]"===e.charAt(e.length-1)?e.substring(1,e.length-1):e}function M(e){if(!function(e){return!(!e||"0.0.0.0"===e||"::"===e||"[::]"===e||"::1"===e||"[::1]"===e)&&-1===e.indexOf(".local")}(e))return!1;var t=D(e);return e=C(e),t?!function(e){return 0===(e=e.toLowerCase()).indexOf("::1")||0===e.indexOf("fe80:")||0===e.indexOf("fc00:")||0===e.indexOf("fd00:")}(e):!function(e){var t=e.split(".");if(4!==t.length)return!0;var n=Number(t[0]),i=Number(t[1]);return 10===n||172===n&&i>=16&&i<=31||192===n&&168===i||169===n&&254===i}(e)}function R(e){if(!e)return!1;var t=e.match(/^a=ice-options:(.*)$/m);return!!(t&&t[1].indexOf("trickle")>=0)}function A(e){var t=null,n=e.match(/a=fingerprint:(\S+)\s+([0-9A-Fa-f:]+)/);if(n&&n.length>=2){var i=n[2];t=Uint8Array.from(i.trim().split(":").map((e=>parseInt(e,16))));var r=i.trim().split(":");t=new Uint8Array(r.length);for(var a=0;a<r.length;a++)t[a]=parseInt(r[a],16)}return t}function I(e){try{if(e){var t=("object"==typeof e&&"sdp"in e?e.sdp:e).match(/^a=ice-ufrag:(.+)$/m);return t?t[1]:null}return null}catch(e){return null}}function P(e){if(!e||"string"!=typeof e)return null;var t=e.trim();if(""===t||/^\s*a=?end-of-candidates\s*$/i.test(t))return null;0===t.indexOf("a=")&&(t=t.substring(2)),0===t.indexOf("candidate:")&&(t=t.substring(10));var n=t.split(/\s+/);if(n.length<8)return null;function i(e){var t=parseInt(e,10);return isNaN(t)?null:0|t}function r(e){var t=parseInt(e,10);return isNaN(t)?0:t>>>0}function a(e){return e&&"["===e.charAt(0)&&"]"===e.charAt(e.length-1)?e.slice(1,-1):e}function o(e){if(!e)return e;var t=e.indexOf("%");return t>=0?e.slice(0,t):e}function l(e){return!(!e||!/\.local$/i.test(e))}var s=n[0],c=i(n[1]),d=(n[2]||"").toLowerCase(),_=r(n[3]),f=n[4],u=r(n[5]);if("typ"!==(n[6]||"").toLowerCase())return null;var p,h=(n[7]||"").toLowerCase(),g=null,m=null,v=null,y=null,b=null,w=null,k=null,T={};for(p=8;p<n.length;p++){var x=(n[p]||"").toLowerCase();if(p+1>=n.length)break;if("raddr"!==x)if("rport"!==x)if("tcptype"!==x)if("generation"!==x)if("ufrag"!==x)if("network-id"!==x)if("network-cost"!==x)if("typ"!==x){var S=n[p+1];null!=S&&(T[x]=S,p++)}else h=(n[++p]||"").toLowerCase();else k=r(n[++p]);else w=i(n[++p]);else b=n[++p];else y=i(n[++p]);else v=(n[++p]||"").toLowerCase();else m=r(n[++p]);else g=n[++p]}f=a(f),g&&(g=a(g)),f=o(f),g&&(g=o(g));var D=l(f),C=!!g&&l(g),M=D?0:f&&f.indexOf(":")>=0?6:4,R=g&&!C?g.indexOf(":")>=0?6:4:0,A="tcp"===d?1:0,I="host"===h?0:"srflx"===h?1:"prflx"===h?2:3,P=null;1===A&&null!=v&&(P="active"===v?0:"passive"===v?1:2);var O=!(!g||C||"0.0.0.0"===g||!m||0===m),N=/^\d+$/.test(s);return{foundation:s,foundationIsNumeric:N,foundationU32:N?parseInt(s,10)>>>0:null,component:null==c?1:0|c,transport:d,transportNum:A,priority:_>>>0,ip:f,ipFamily:M,isMdns:D,port:u>>>0,type:h,typeNum:I,hasRel:O,relIp:O?g:null,relIpFamily:O?R:0,relIsMdns:!!O&&C,relPort:O?m>>>0:0,hasTcpType:null!=P,tcpType:null==P?null:0|P,tcpTypeStr:v,generation:null==y?null:0|y,networkId:null==w?null:0|w,networkCost:null==k?null:k>>>0,ufrag:b||null,localIP:f,localPort:u>>>0,remoteIP:O?g:null,remotePort:O?m>>>0:null,extras:T}}function O(e){return e.split("\r\n").filter((e=>!e.startsWith("a=candidate"))).join("\r\n")}var N="idle",U=null,L=[],E=0;function q(e,t){for(var n=0;n<L.length;n++)try{L[n](e,t)}catch(e){}L.length=0}function B(e){e||(e=function(){}),"ready"===N&&function(){if(!U)return!1;var e="number"==typeof U.expires?U.expires:E;return!e||Date.now()+6e4<e}()?e(null,U):(L.push(e),"generating"!==N&&function(){var e;N="generating";try{e=RTCPeerConnection.generateCertificate({name:"ECDSA",namedCurve:"P-256"})}catch(e){return N="failed",void q(e,null)}e.then((function(e){U=e,E="number"==typeof e.expires?0|e.expires:0,N="ready",q(null,e)}),(function(e){N="failed",q(e,null)}))}())}return function e(t){if(!(this instanceof e))return new e(t);if((t=t||{}).wrtc&&"object"==typeof t.wrtc){var n=t.wrtc;void 0!==n.MediaStream&&void 0===global.MediaStream&&(global.MediaStream=n.MediaStream),void 0!==n.MediaStreamTrack&&void 0===global.MediaStreamTrack&&(global.MediaStreamTrack=n.MediaStreamTrack),void 0!==n.RTCDataChannel&&void 0===global.RTCDataChannel&&(global.RTCDataChannel=n.RTCDataChannel),void 0!==n.RTCDataChannelEvent&&void 0===global.RTCDataChannelEvent&&(global.RTCDataChannelEvent=n.RTCDataChannelEvent),void 0!==n.RTCDtlsTransport&&void 0===global.RTCDtlsTransport&&(global.RTCDtlsTransport=n.RTCDtlsTransport),void 0!==n.RTCIceCandidate&&void 0===global.RTCIceCandidate&&(global.RTCIceCandidate=n.RTCIceCandidate),void 0!==n.RTCIceTransport&&void 0===global.RTCIceTransport&&(global.RTCIceTransport=n.RTCIceTransport),void 0!==n.RTCPeerConnection&&void 0===global.RTCPeerConnection&&(global.RTCPeerConnection=n.RTCPeerConnection),void 0!==n.RTCPeerConnectionIceEvent&&void 0===global.RTCPeerConnectionIceEvent&&(global.RTCPeerConnectionIceEvent=n.RTCPeerConnectionIceEvent),void 0!==n.RTCRtpReceiver&&void 0===global.RTCRtpReceiver&&(global.RTCRtpReceiver=n.RTCRtpReceiver),void 0!==n.RTCRtpSender&&void 0===global.RTCRtpSender&&(global.RTCRtpSender=n.RTCRtpSender),void 0!==n.RTCRtpTransceiver&&void 0===global.RTCRtpTransceiver&&(global.RTCRtpTransceiver=n.RTCRtpTransceiver),void 0!==n.RTCSctpTransport&&void 0===global.RTCSctpTransport&&(global.RTCSctpTransport=n.RTCSctpTransport),void 0!==n.RTCSessionDescription&&void 0===global.RTCSessionDescription&&(global.RTCSessionDescription=n.RTCSessionDescription)}var a,o=(a={},{on:function(e,t){(a[e]=a[e]||[]).push(t)},emit:function(e){for(var t=Array.prototype.slice.call(arguments,1),n=a[e]||[],i=0;i<n.length;i++)try{n[i].apply(null,t)}catch(e){}}}),c={create_time:Date.now(),pc_config:{},pc:null,local_public_ipv4:[],local_public_ipv6:[],local_relay_ipv4:[],local_relay_ipv6:[],local_support_udp:null,local_support_tcp:null,local_nat_type:"unknown",local_support_trickle_ice:null,remote_support_trickle_ice:null,current_local_protocol:null,current_remote_protocol:null,current_local_relay:null,current_remote_relay:null,current_local_ip:null,current_remote_ip:null,current_local_port:null,current_remote_port:null,current_rtt:null,signaling_state:"new",signaling_channel_state:"new",negotiation_state:0,create_offer_timer:null,auth_verified:!1,local_nonce:Math.floor(65536*Math.random()),remote_nonce:0,create_data_channel_timer:null,list_data_channels:[],list_remote_candidates:{},list_gathered_local_candidates:{},remote_fingerprint:null,local_fingerprint:null,getstats_running:!1,getstats_timer:null,last_local_ufrag:null,last_remote_ufrag:null,need_ice_restart:!1,wait_for_answer_timeout_timer:null,negotiation_done_timeout_timer:null,making_rollback:!1,pending_remote_offer_sdp:null,sent_local_offer_sdp:null,sent_local_answer_sdp:null,base_offer_sdp:null,local_offer_history:[],seq_remote_offer:0,seq_local_mediastream_map:0,seq_remote_mediastream_map:0,epoch_negotiation_success:0,best_candidate_pair_priority:0,data_channel_primary_index:null,data_channel_state:"new",data_channel_connect_time:null,sctp_dtls_state:"new",sctp_ice_state:"new",sctp_state:"new",sctp:null,remove_unused_tracks_timer:null,created_transceivers:[],list_sending_live_mediastream:{},list_receiving_live_mediastream:{},data_channel_sending_messages_queue:[],data_channel_sending_messages_paused:!1,data_channel_min_buffered_amount:65536,data_channel_max_buffered_amount:1048576,data_channel_max_sending_messages_per_sec:1e3,data_channel_max_sending_bytes_per_sec:65536,data_channel_pump_queue_timer:null,data_channel_sent_events:[],data_channel_recv_events:[]};function d(){if(c.pc&&"closed"!==c.pc.connectionState&&c.pc.remoteDescription&&c.pc.remoteDescription.type){var e=I(c.pc.remoteDescription.sdp);if(e&&e in c.list_remote_candidates==1)if(c.list_remote_candidates[e].pending.length>0){var t=c.list_remote_candidates[e].pending.shift();c.list_remote_candidates[e].drained++,c.pc.addIceCandidate(t).then((function(){setTimeout(d,0)})).catch((function(e){o.emit("error",e),setTimeout(d,0)}))}else c.list_remote_candidates[e].total>0&&c.list_remote_candidates[e].drained==c.list_remote_candidates[e].total&&c.pc.addIceCandidate(null)}}function _(e){null==c.remote_support_trickle_ice&&(c.remote_support_trickle_ice=!0);var t="default";if(e&&"usernameFragment"in e&&e.usernameFragment.length>0)t=e.usernameFragment;else{var n=P(e.candidate);"ufrag"in n&&n.ufrag.length>0&&(t=n.ufrag)}t in c.list_remote_candidates==0&&(c.list_remote_candidates[t]={total:0,drained:0,pending:[],all:[]}),c.list_remote_candidates[t].all.indexOf(e.candidate)<0&&(c.list_remote_candidates[t].all.push(e.candidate),c.list_remote_candidates[t].pending.push(e),c.list_remote_candidates[t].pending.length>=2&&c.list_remote_candidates[t].pending.sort((function(e,t){var n=P(e.candidate),i=P(t.candidate),r=n.priority+("tcp"===n.type?1:0),a=i.priority+("tcp"===i.type?1:0);return r===a&&"foundation"in n&&"foundation"in i&&null!==n.foundation&&null!==i.foundation?n.foundation.localeCompare(i.foundation):a-r})),d())}function f(){if(c.pc&&"closed"!==c.pc.connectionState){for(var e=null,t=null,n=0;n<c.list_data_channels.length;n++){(i=c.list_data_channels[n])&&"open"==i.readyState&&"number"==typeof i.id&&(null===t||i.id<t)&&(t=i.id,e=n)}if(null==e)c.data_channel_primary_index=null,g({data_channel_state:"close"});else{c.data_channel_primary_index=e,g({data_channel_state:String(c.list_data_channels[c.data_channel_primary_index].readyState)+""});for(n=0;n<c.list_data_channels.length;n++){var i;if((i=c.list_data_channels[n])&&"open"==i.readyState&&"number"==typeof i.id&&c.list_data_channels[c.data_channel_primary_index].id!==i.id)try{i.close()}catch(e){}}}}}function u(){clearTimeout(c.create_offer_timer),c.create_offer_timer=null,c.create_offer_timer=setTimeout((function(){c.create_offer_timer=null,c.pc&&0==c.negotiation_state&&1==function(){for(var e=!1,t=0,n=0;n<c.list_data_channels.length;n++){var i=c.list_data_channels[n];i&&"close"!==i.readyState&&"closing"!==i.readyState&&"open"!=i.readyState&&t++}t>0&&c.pc&&(!c.pc.currentRemoteDescription||c.pc.currentRemoteDescription.sdp.indexOf("m=application")<0)&&(e=!0);var r=!1;for(var n in c.created_transceivers)if(c.created_transceivers[n].tc&&(0==c.created_transceivers[n].tc.stopped&&"sendonly"==c.created_transceivers[n].tc.direction&&null==c.created_transceivers[n].tc.mid||1==c.created_transceivers[n].tc.stopped&&null!==c.created_transceivers[n].tc.mid)){r=!0;break}return 1==e||1==r||1==c.need_ice_restart}()&&function(){if(c.pc&&"closed"!==c.pc.connectionState&&0==c.negotiation_state&&"have-remote-offer"!==c.pc.signalingState){g({negotiation_state:1}),c.local_offer_history.push([0,0,0]);var e=Number(c.local_offer_history.length)+0,t={};1==c.need_ice_restart&&(t.iceRestart=!0),c.pc.createOffer(t).then((function(t){if(1==c.negotiation_state&&"have-remote-offer"!==c.pc.signalingState&&e==c.local_offer_history.length){if("toJSON"in t&&"function"==typeof t.toJSON)var n=t.toJSON();else n=t;var r=O(n.sdp);c.pc.setLocalDescription(new RTCSessionDescription({type:"offer",sdp:r})).then((function(){if(null==c.local_support_trickle_ice&&(c.local_support_trickle_ice=R(c.pc.localDescription.sdp)),1==c.negotiation_state&&c.pc.localDescription&&e==c.local_offer_history.length){c.sent_local_offer_sdp=r,c.local_offer_history[e-1][0]=Date.now(),function(e,t,n){var r=null,a=null,o=null,s=null,c=null,d=1;function _(){var t=[];t.push([1,n.length]),null!==o&&t.push([2,o.byteLength]),null!==c&&t.push([3,c.byteLength]),null!==s&&t.push([4,s.byteLength]),t.sort((function(e,t){return e[1]!==t[1]?e[1]-t[1]:e[0]-t[0]}));var i=t[0][0];if(1==i)j(1,p([16],[e,n]));else if(2==i){j(2,p([16],[e,o]))}else if(3==i){j(3,p([16,32,32],[e,r,a,c]))}else if(4==i){j(4,p([16,32,32],[e,r,a,s]))}}null!==t?(r=w(t),a=w(n),s=i(t,n),d++,l(s,(function(e){null!==e&&e.byteLength<s.length&&(c=e),4==++d&&_()}))):(d++,4==++d&&_());l(n,(function(e){null!==e&&e.byteLength<n.length&&(o=e),4==++d&&_()}))}(e,c.base_offer_sdp,r),clearTimeout(c.wait_for_answer_timeout_timer),c.wait_for_answer_timeout_timer=null;var t=7e3;for(var n in c.local_offer_history)if(c.local_offer_history[n][1]>0){var a=c.local_offer_history[n][1]-c.local_offer_history[n][0];a+2>t&&(t=a+2)}c.wait_for_answer_timeout_timer=setTimeout((function(){c.wait_for_answer_timeout_timer=null,2==c.negotiation_state&&g({negotiation_state:0})}),t),g({negotiation_state:2})}})).catch((function(t){1==c.negotiation_state&&e==c.local_offer_history.length&&g({negotiation_state:0}),o.emit("error",t)}))}})).catch((function(t){1==c.negotiation_state&&e==c.local_offer_history.length&&g({negotiation_state:0}),o.emit("error",t)}))}}()}),5+Math.floor(10*Math.random()))}function g(e){var t=!1,n=["sctp_state","sctp_ice_state","sctp_dtls_state","data_channel_state","negotiation_state","signaling_state","current_remote_protocol","current_local_protocol","current_remote_relay","current_local_relay","current_local_ip","current_remote_ip","current_local_port","current_remote_port","current_rtt"],i={};for(var r in n)i[n[r]]=structuredClone(c[n[r]]);if(e&&"object"==typeof e)for(var r in n)n[r]in e&&c[n[r]]!==e[n[r]]&&(c[n[r]]=e[n[r]],t=!0);if(1==t&&("open"==c.data_channel_state&&c.data_channel_state!==i.data_channel_state&&(null!=c.data_channel_connect_time&&0!=c.data_channel_connect_time||(c.data_channel_connect_time=Date.now(),o.emit("connect")),N(),X()),c.negotiation_state!==i.negotiation_state&&(2!==c.negotiation_state&&(clearTimeout(c.wait_for_answer_timeout_timer),c.wait_for_answer_timeout_timer=null),0==c.negotiation_state&&(!function(){if(c.pc&&"closed"!==c.pc.connectionState&&c.pc.sctp&&null==c.sctp){c.sctp=c.pc.sctp,f();try{c.pc.sctp.transport&&c.pc.sctp.transport.iceTransport&&g({sctp_ice_state:String(c.pc.sctp.transport.iceTransport.state)+""})}catch(e){o.emit("error",e)}try{c.pc.sctp.transport&&g({sctp_dtls_state:String(c.pc.sctp.transport.state)+""})}catch(e){o.emit("error",e)}try{g({sctp_state:String(c.pc.sctp.state)+""})}catch(e){o.emit("error",e)}try{c.pc.sctp.transport&&c.pc.sctp.transport.iceTransport&&"onstatechange"in c.pc.sctp.transport.iceTransport&&(c.pc.sctp.transport.iceTransport.onstatechange=function(){c.pc&&"closed"!==c.pc.connectionState&&(g({sctp_ice_state:String(c.pc.sctp.transport.iceTransport.state)+""}),f())})}catch(e){o.emit("error",e)}try{c.pc.sctp.transport&&"onstatechange"in c.pc.sctp.transport&&(c.pc.sctp.transport.onstatechange=function(){c.pc&&"closed"!==c.pc.connectionState&&(g({sctp_dtls_state:String(c.pc.sctp.transport.state)+""}),f())})}catch(e){o.emit("error",e)}try{"onstatechange"in c.pc.sctp&&(c.pc.sctp.onstatechange=function(){c.pc&&"closed"!==c.pc.connectionState&&(g({sctp_state:String(c.pc.sctp.state)+""}),f())})}catch(e){o.emit("error",e)}try{c.pc.sctp.transport&&c.pc.sctp.transport.iceTransport&&"onselectedcandidatepairchange"in c.pc.sctp.transport.iceTransport&&(c.pc.sctp.transport.iceTransport.onselectedcandidatepairchange=function(){selected_candidate_pair=c.pc.sctp.transport.iceTransport.getSelectedCandidatePair(),g({local_protocol:selected_candidate_pair.local.protocol,remote_protocol:selected_candidate_pair.remote.protocol}),N()})}catch(e){o.emit("error",e)}}}(),H(),J(),null!==c.pending_remote_offer_sdp?!c.pc||0!=c.negotiation_state&&2!=c.negotiation_state&&5!=c.negotiation_state||E():null==c.create_offer_timer&&u()),5==c.negotiation_state?(clearTimeout(c.negotiation_done_timeout_timer),c.negotiation_done_timeout_timer=null,c.negotiation_done_timeout_timer=setTimeout((function(){c.negotiation_done_timeout_timer=null,5==c.negotiation_state&&g({negotiation_state:0})}),7e3)):null!==c.negotiation_done_timeout_timer&&(clearTimeout(c.negotiation_done_timeout_timer),c.negotiation_done_timeout_timer=null)),c.signaling_state!==i.signaling_state&&("stable"==c.signaling_state||"have-remote-offer"==c.signaling_state))){var a=!1;if(c.pc.remoteDescription&&c.pc.remoteDescription.type&&null==c.remote_fingerprint&&(c.remote_fingerprint=A(c.pc.remoteDescription.sdp),null!==c.local_fingerprint&&(a=!0)),c.pc.localDescription&&c.pc.localDescription.type&&null==c.local_fingerprint&&(c.local_fingerprint=A(c.pc.localDescription.sdp),null!==c.remote_fingerprint&&(a=!0)),a&&o.emit("fingerprints",c.local_fingerprint,c.remote_fingerprint),"stable"==c.signaling_state&&c.pc.currentRemoteDescription&&c.pc.currentRemoteDescription.type&&c.pc.currentLocalDescription&&c.pc.currentLocalDescription.type){var l=I(c.pc.currentRemoteDescription.sdp),s=I(c.pc.currentLocalDescription.sdp);if(s&&l){var d=!1;null!=c.last_local_ufrag&&c.last_local_ufrag===s||(c.last_local_ufrag=s,d=!0),null!=c.last_remote_ufrag&&c.last_remote_ufrag===l||(c.last_remote_ufrag=l,!0),d&&1==c.need_ice_restart&&(c.need_ice_restart=!1)}}}}function m(e){if(c.pc&&"closed"!==c.pc.connectionState){c.list_data_channels.push(e);e.binaryType="arraybuffer",e.bufferedAmountLowThreshold=c.data_channel_min_buffered_amount,e.onopen=function(e){f()},e.onmessage=function(e){var t=Date.now(),n=e.data.length;for(c.data_channel_recv_events.push([t,n]);c.data_channel_recv_events.length&&t-c.data_channel_recv_events[0][0]>1e3;)c.data_channel_recv_events.shift();var i=h([8],e.data);0==i[0]?o.emit("data",i[1]):z(i[0],i[1])},e.onbufferedamountlow=function(){X()},e.onclosing=function(e){f()},e.onclose=function(e){f(),c.pc&&c.pc.connectionState},e.onerror=function(e){f(),c.pc&&"closed"!==c.pc.connectionState&&o.emit("error",e)}}}function N(){c.pc&&"closed"!==c.pc.signalingState&&c.pc.getStats&&0==c.getstats_running&&(c.getstats_running=!0,null!==c.getstats_timer&&(clearTimeout(c.getstats_timer),c.getstats_timer=null),c.pc.getStats().then((function(e){try{c.getstats_running=!1;var t={};if(e.forEach((function(e){e.type in t==0&&(t[e.type]={}),t[e.type][e.id]=e})),"transport"in t)for(var n in t.transport){if("selectedCandidatePairId"in t.transport[n]){var i=t.transport[n].selectedCandidatePairId,r=null,a=null,l=null;if("local-candidate"in t&&"candidate-pair"in t&&i in t["candidate-pair"]&&(r=t["local-candidate"][t["candidate-pair"][i].localCandidateId]),"remote-candidate"in t&&"candidate-pair"in t&&i in t["candidate-pair"]&&(a=t["remote-candidate"][t["candidate-pair"][i].remoteCandidateId]),"candidate-pair"in t&&i in t["candidate-pair"]&&(l=t["candidate-pair"][i]),null!==r&&null!==a&&null!==l){var s=r.protocol,d=a.protocol,_=null;"currentRoundTripTime"in l&&(_=1e3*Number(l.currentRoundTripTime));var u=!1,p=!1;"relay"==r.candidateType&&(u=!0),"relay"==a.candidateType&&(p=!0);var h=Number(l.priority),m=l.state,v=null,y=null,b=null,w=null;"srflx"==r.candidateType&&("ip"in r&&(v=r.ip),"port"in r&&(y=r.port)),"srflx"==a.candidateType&&("ip"in a&&(b=a.ip),"port"in a&&(w=a.port)),"succeeded"==m&&(g({current_local_protocol:s,current_remote_protocol:d,current_local_relay:u,current_remote_relay:p,current_local_ip:v,current_remote_ip:b,current_local_port:y,current_remote_port:w,current_rtt:_}),(c.best_candidate_pair_priority<h||c.best_candidate_pair_priority>h)&&(c.best_candidate_pair_priority=h))}}if("iceState"in t.transport[n])g({sctp_ice_state:t.transport[n].iceState});if("dtlsState"in t.transport[n])g({sctp_dtls_state:t.transport[n].dtlsState})}if("data-channel"in t){for(var n in t["data-channel"]);f()}if("candidate-pair"in t)for(var n in t["candidate-pair"]);if("outbound-rtp"in t)for(var n in t["outbound-rtp"]){var k=null;if("codec"in t&&"codecId"in t["outbound-rtp"][n]&&t["outbound-rtp"][n].codecId in t.codec&&"mimeType"in t.codec[t["outbound-rtp"][n].codecId]&&(k=t.codec[t["outbound-rtp"][n].codecId].mimeType),"mid"in t["outbound-rtp"][n]){for(var T in 1==t["outbound-rtp"][n].active&&1,c.list_sending_live_mediastream)Number(t["outbound-rtp"][n].mid)==c.list_sending_live_mediastream[T].video_mid?("frameHeight"in t["outbound-rtp"][n]&&(c.list_sending_live_mediastream[T].current_video_frame_height=t["outbound-rtp"][n].frameHeight),"frameWidth"in t["outbound-rtp"][n]&&(c.list_sending_live_mediastream[T].current_video_frame_width=t["outbound-rtp"][n].frameWidth),"framesPerSecond"in t["outbound-rtp"][n]&&(c.list_sending_live_mediastream[T].current_video_fps=t["outbound-rtp"][n].framesPerSecond),null!==k&&(c.list_sending_live_mediastream[T].current_video_mime_type=k)):Number(t["outbound-rtp"][n].mid)==c.list_sending_live_mediastream[T].audio_mid&&null!==k&&(c.list_sending_live_mediastream[T].audio_mime_type=k)}}if("inbound-rtp"in t)for(var n in t["inbound-rtp"]){k=null;if("codec"in t&&"codecId"in t["inbound-rtp"][n]&&t["inbound-rtp"][n].codecId in t.codec&&"mimeType"in t.codec[t["inbound-rtp"][n].codecId]&&(k=t.codec[t["inbound-rtp"][n].codecId].mimeType),"mid"in t["inbound-rtp"][n])for(var T in c.list_receiving_live_mediastream)Number(t["inbound-rtp"][n].mid)==c.list_receiving_live_mediastream[T].video_mid?("frameHeight"in t["inbound-rtp"][n]&&(c.list_receiving_live_mediastream[T].current_video_frame_height=t["inbound-rtp"][n].frameHeight),"frameWidth"in t["inbound-rtp"][n]&&(c.list_receiving_live_mediastream[T].current_video_frame_width=t["inbound-rtp"][n].frameWidth),"framesPerSecond"in t["inbound-rtp"][n]&&(c.list_receiving_live_mediastream[T].current_video_fps=t["inbound-rtp"][n].framesPerSecond),null!==k&&(c.list_receiving_live_mediastream[T].current_video_mime_type=k)):Number(t["inbound-rtp"][n].mid)==c.list_receiving_live_mediastream[T].audio_mid&&null!==k&&(c.list_receiving_live_mediastream[T].current_audio_mime_type=k)}c.getstats_timer=setTimeout(N,1e3)}catch(e){o.emit("error",e),c.getstats_running=!1}})).catch((function(e){o.emit("error",e),c.getstats_running=!1})))}function U(e,t){null==c.remote_support_trickle_ice&&(c.remote_support_trickle_ice=R(e)),c.local_offer_history.length<=t&&0==c.local_offer_history[t-1][1]&&(c.local_offer_history[t-1][1]=Date.now()),2==c.negotiation_state&&"have-local-offer"==c.pc.signalingState?t==c.local_offer_history.length?(g({negotiation_state:3}),c.pc.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:e})).then((function(){d(),3==c.negotiation_state&&t==c.local_offer_history.length&&(c.base_offer_sdp=String(c.sent_local_offer_sdp)+"",c.epoch_negotiation_success++,0==c.local_offer_history[t-1][2]&&(c.local_offer_history[t-1][2]=Date.now()),j(12,p([16,16],[t,c.epoch_negotiation_success])),g({negotiation_state:0}))})).catch((function(e){3==c.negotiation_state&&t==c.local_offer_history.length&&L((function(){g({negotiation_state:0})})),o.emit("error",e)}))):o.emit("error","answer for old offer"):o.emit("error","not have local offer")}function L(e){c.pc&&("stable"==c.pc.signalingState?"function"==typeof e&&e(!0):0==c.making_rollback&&(c.making_rollback=!0,c.pc.setLocalDescription({type:"rollback"}).then((function(){c.making_rollback=!1,"function"==typeof e&&e(!0)})).catch((function(t){c.making_rollback=!1,"function"==typeof e&&e(!1),o.emit("error",t)}))))}function E(){if(null!==c.pending_remote_offer_sdp){function e(){if(4==c.negotiation_state&&"have-remote-offer"==c.pc.signalingState){var e=Number(c.seq_remote_offer)+0;c.pc.createAnswer().then((function(t){if(4==c.negotiation_state&&"have-remote-offer"==c.pc.signalingState&&e==c.seq_remote_offer){if("toJSON"in t&&"function"==typeof t.toJSON)var n=t.toJSON();else n=t;var r=O(n.sdp);c.pc.setLocalDescription(new RTCSessionDescription({type:"answer",sdp:r})).then((function(){null==c.local_support_trickle_ice&&(c.local_support_trickle_ice=R(c.pc.localDescription.sdp)),e==c.seq_remote_offer&&(c.sent_local_answer_sdp=r,function(e,t,n){var r=null,a=null,o=null,s=null,c=null,d=1;function _(){var t=[];t.push([1,n.length]),null!==o&&t.push([2,o.byteLength]),null!==c&&t.push([3,c.byteLength]),null!==s&&t.push([4,s.byteLength]),t.sort((function(e,t){return e[1]!==t[1]?e[1]-t[1]:e[0]-t[0]}));var i=t[0][0];if(1==i)j(5,p([16],[e,n]));else if(2==i){j(6,p([16],[e,o]))}else if(3==i){j(7,p([16,32,32],[e,r,a,c]))}else if(4==i){j(8,p([16,32,32],[e,r,a,s]))}}null!==t?(r=w(t),a=w(n),s=i(t,n),d++,l(s,(function(e){null!==e&&e.byteLength<s.length&&(c=e),4==++d&&_()}))):(d++,4==++d&&_());l(n,(function(e){null!==e&&e.byteLength<n.length&&(o=e),4==++d&&_()}))}(e,c.pending_remote_offer_sdp,r),c.base_offer_sdp=String(c.pending_remote_offer_sdp)+"",c.pending_remote_offer_sdp=null,g({negotiation_state:5}))})).catch((function(t){e==c.seq_remote_offer&&L((function(){g({negotiation_state:0})})),o.emit("error",t)}))}})).catch((function(t){e==c.seq_remote_offer&&L((function(){g({negotiation_state:0})})),o.emit("error",t)}))}}g({negotiation_state:4}),L((function(){var t=Number(c.seq_remote_offer)+0;c.pc.setRemoteDescription(new RTCSessionDescription({type:"offer",sdp:c.pending_remote_offer_sdp})).then((function(){d(),t==c.seq_remote_offer&&e()})).catch((function(e){4==c.negotiation_state&&t==c.seq_remote_offer&&(c.pending_remote_offer_sdp=null,g({negotiation_state:0})),o.emit("error",e)}))}))}}function q(e,t){if(null==c.remote_support_trickle_ice&&(c.remote_support_trickle_ice=R(e)),t>c.seq_remote_offer){c.seq_remote_offer=t,c.pending_remote_offer_sdp=null;var n=c.remote_nonce>c.local_nonce,i=c.epoch_negotiation_success%2==0?n:!n;0!=c.negotiation_state&&1!=i||(c.pending_remote_offer_sdp=e,!c.pc||0!=c.negotiation_state&&2!=c.negotiation_state&&5!=c.negotiation_state||E())}else o.emit("error","offer is old or already processed")}function F(e,t){j(3,p([8,16],[e,t]))}function j(e,t){if(1==(null!==c.data_channel_primary_index&&c.list_data_channels[c.data_channel_primary_index]&&"open"==c.list_data_channels[c.data_channel_primary_index].readyState&&"open"==c.data_channel_state)){Z(p([8],[e,t]))}else{var n=p([16,16,8],[c.local_nonce,c.remote_nonce,e,t]),i=p([32],[k(n),n]);o.emit("signal",i)}}function z(e,t){if(e>=1&&e<=4)if(e>=3){var n=(a=h([16,32,32],t))[0];if(w(c.base_offer_sdp)==a[1])if(3==e)s(a[3],(function(t){if(null!==t){var i=r(c.base_offer_sdp,t);w(i)==a[2]?q(i,n):F(e,n)}else F(e,n)}));else w(i=r(c.base_offer_sdp,(new TextDecoder).decode(a[3])))==a[2]?q(i,n):F(e,n);else F(e,n)}else{n=(a=h([16],t))[0];1==e?q((new TextDecoder).decode(a[1]),n):s(a[1],(function(t){null!==t?q(t,n):F(e,n)}))}else if(e>=5&&e<=8)if(e>=7){var i;n=(a=h([16,32,32],t))[0];if(w(c.sent_local_offer_sdp)==a[1])if(7==e)s(a[3],(function(t){if(null!==t){var i=r(c.sent_local_offer_sdp,t);w(i)==a[2]?U(i,n):F(e,n)}else F(e,n)}));else w(i=r(c.sent_local_offer_sdp,(new TextDecoder).decode(a[3])))==a[2]?U(i,n):F(e,n);else F(e,n)}else{n=(a=h([16],t))[0];5==e?U((new TextDecoder).decode(a[1]),n):s(a[1],(function(t){null!==t?U(t,n):F(e,n)}))}else if(9==e)try{_(JSON.parse((new TextDecoder).decode(t)))}catch(e){o.emit("error",e)}else if(10==e)try{_(b(y(t)))}catch(e){o.emit("error",e)}else if(11==e){var a=h([16],t);l=a[0],(f=(new TextDecoder).decode(a[1]))in c.list_remote_candidates==0&&(c.list_remote_candidates[f]={total:0,drained:0,list:[]}),c.list_remote_candidates[f].total=l,c.list_remote_candidates[f].total>0&&c.list_remote_candidates[f].total==c.list_remote_candidates[f].drained&&d()}else if(12==e){!function(e,t){c.seq_remote_offer==e&&(c.epoch_negotiation_success=t,5==c.negotiation_state&&(clearTimeout(c.negotiation_done_timeout_timer),c.negotiation_done_timeout_timer=null,g({negotiation_state:0})))}((a=h([16,16],t))[0],a[1])}else if(13==e)try{a=h([16],t);!function(e,t){if(t>c.seq_remote_mediastream_map){for(var n in c.seq_remote_mediastream_map=t,c.list_receiving_live_mediastream){var i=!0;for(var r in e)String(r)==String(n)&&(i=!1);1==i&&V(n,{video_mid:null,audio_mid:null})}for(var n in e)V(n,{video_mid:e[n].video_mid,audio_mid:e[n].audio_mid})}}(JSON.parse((new TextDecoder).decode(a[1])),a[0])}catch(e){o.emit("error",e)}else if(14==e){n=(a=h([8,16],t))[1];a[0]>=1&&a[0]<=4?n==c.local_offer_history.length&&function(e,t){j(1,p([16],[e,t]))}(n,c.sent_local_offer_sdp):a[0]>=5&&a[0]<=8&&n==c.seq_remote_offer&&null!==c.sent_local_offer_sdp&&function(e,t){j(5,p([16],[e,t]))}(n,c.sent_local_offer_sdp)}var l,f}function J(){if(c.pc&&"function"==typeof c.pc.getTransceivers){var e=c.pc.getTransceivers();for(var t in c.list_receiving_live_mediastream){var n=null,i=null;if(null!==c.list_receiving_live_mediastream[t].video_mid)for(var r=0;r<e.length;r++){(a=e[r])&&a.receiver&&a.receiver.track&&"ended"!==a.receiver.track.readyState&&"video"===a.receiver.track.kind&&String(c.list_receiving_live_mediastream[t].video_mid)==String(a.mid)&&(n=a.receiver.track)}if(null!==c.list_receiving_live_mediastream[t].audio_mid)for(r=0;r<e.length;r++){var a;(a=e[r])&&a.receiver&&a.receiver.track&&"ended"!==a.receiver.track.readyState&&"audio"===a.receiver.track.kind&&String(c.list_receiving_live_mediastream[t].audio_mid)==String(a.mid)&&(i=a.receiver.track)}V(t,{video_track:n,audio_track:i})}}}function V(e,t){e in c.list_receiving_live_mediastream==0&&(c.list_receiving_live_mediastream[e]={video_track:null,audio_track:null,video_mid:null,audio_mid:null,mediastream:new MediaStream,current_video_frame_height:0,current_video_frame_width:0,current_video_fps:0,current_video_mime_type:null,current_audio_mime_type:null});var n=c.list_receiving_live_mediastream[e],i=!1,r=!1;if(t&&"object"==typeof t){if("video_mid"in t){var a=null!=t.video_mid&&String(t.video_mid).length?String(t.video_mid):null;n.video_mid!==a&&(n.video_mid=a,i=!0,r=!0,null==a&&null!=n.video_track&&(n.video_track=null,i=!0))}if("audio_mid"in t){var l=null!=t.audio_mid&&String(t.audio_mid).length?String(t.audio_mid):null;n.audio_mid!==l&&(n.audio_mid=l,i=!0,r=!0,null==l&&null!=n.audio_track&&(n.audio_track=null,i=!0))}if("video_track"in t&&(null==n.video_track&&null!==t.video_track||null!==n.video_track&&null==t.video_track||0==S(n.video_track,t.video_track))){var s=n.mediastream.getVideoTracks();for(var d in s)n.mediastream.removeTrack(s[d]);null!==t.video_track&&n.mediastream.addTrack(t.video_track),n.video_track=t.video_track,i=!0}if("audio_track"in t&&(null==n.audio_track&&null!==t.audio_track||null!==n.audio_track&&null==t.audio_track||0==S(n.audio_track,t.audio_track))){var _=n.mediastream.getAudioTracks();for(var d in _)n.mediastream.removeTrack(_[d]);null!==t.audio_track&&n.mediastream.addTrack(t.audio_track),n.audio_track=t.audio_track,i=!0}}1==r&&J(),1==i&&o.emit("stream",n.mediastream,{tag_id:e,video_track:n.video_track,audio_track:n.audio_track,video_mid:n.video_mid,audio_mid:n.audio_mid})}function $(){clearTimeout(c.remove_unused_tracks_timer),c.remove_unused_tracks_timer=null;var e,t,n=Object.create(null);for(e in c.list_sending_live_mediastream)(t=c.list_sending_live_mediastream[e])&&(t.video_mid&&(n[t.video_mid]=!0),t.audio_mid&&(n[t.audio_mid]=!0));for(var i=c.pc.getTransceivers(),r=!1,a=0;a<i.length;a++){var o=i[a];if(o&&o.sender){for(var l=!1,s=0;s<c.created_transceivers.length;s++)if(c.created_transceivers[s].tc===o){l=!0;break}if(l){var d="string"==typeof o.mid&&o.mid.length?o.mid:null;if(d){var _=!o.sender.track,f=!n[d];if(_&&f){try{o.stop()}catch(e){}for(e in c.list_sending_live_mediastream)(t=c.list_sending_live_mediastream[e])&&(t.video_mid===d&&(t.video_mid=null),t.audio_mid===d&&(t.audio_mid=null));r=!0}}}}}r&&u()}function W(e,t){var n=c.pc.addTransceiver(e,{direction:"sendonly"});return c.created_transceivers.push({tc:n,kind:e}),u(),n}function H(){if(c.pc&&"function"==typeof c.pc.getTransceivers){function e(e){var t=null!=e.currentDirection?e.currentDirection:e.direction;return"sendonly"===t||"sendrecv"===t}function t(e){return!(e.sender&&e.sender.track)}function n(e){for(var t=0;t<c.created_transceivers.length;t++)if(c.created_transceivers[t].tc===e)return c.created_transceivers[t].kind;return null}function i(e,t){if(!e)return null;for(var n=0;n<u.length;n++){var i=u[n];if(i&&i.mid===e&&i.sender&&(!t||i.sender.track&&i.sender.track.kind===t))return i}return null}function r(e,t){function n(e){return{active:e.active,maxBitrate:0|e.maxBitrate,maxFramerate:0|e.maxFramerate,scaleResolutionDownBy:null==e.scaleResolutionDownBy?1:e.scaleResolutionDownBy}}if(!e&&!t)return!0;if(!e||!t)return!1;if(e.length!==t.length)return!1;for(var i=0;i<e.length;i++){var r=n(e[i]||{}),a=n(t[i]||{});if(r.active!==a.active||r.maxBitrate!==a.maxBitrate||r.maxFramerate!==a.maxFramerate||r.scaleResolutionDownBy!==a.scaleResolutionDownBy)return!1}return!0}var a=0,o=0,l=[];for(var s in c.list_sending_live_mediastream){var d=c.list_sending_live_mediastream[s];d.video_track&&a++,d.audio_track&&o++,l.push(s)}for(var _=[],f=[],u=c.pc.getTransceivers(),h=0;h<u.length;h++){var g=u[h];if(g&&e(g)){var m=n(g);"video"===m?_.push(g):"audio"===m&&f.push(g)}}var v=!1,y=!1;if(a>_.length)for(var b=a-_.length,w=0;w<b;w++){var k=W("video");_.push(k),!0}else if(a<_.length)for(var T=_.length-a,x=_.length-1;x>=0&&T>0;x--){var S=_[x];if(S&&S.sender){var D=!!S.sender.track;try{S.sender.replaceTrack(null)}catch(ve){}v=!0,D&&(y=!0),T--}}if(o>f.length)for(var C=o-f.length,M=0;M<C;M++){var R=W("audio");f.push(R),!0}else if(o<f.length)for(var A=f.length-o,I=f.length-1;I>=0&&A>0;I--){var P=f[I];if(P&&P.sender){var O=!!P.sender.track;try{P.sender.replaceTrack(null)}catch(ye){}v=!0,O&&(y=!0),A--}}for(var N=0;N<l.length;N++){var U=l[N];if(null!=(x=c.list_sending_live_mediastream[U]).video_mid){var L=i(x.video_mid,"video"),E=!x.video_track||!L||!e(L);if(E&&L&&L.sender){var q=!!L.sender.track;try{L.sender.replaceTrack(null)}catch(be){}v=!0,q&&(y=!0)}E&&(x.video_mid=null,y=!0)}if(null!=x.audio_mid){var B=i(x.audio_mid,"audio"),F=!x.audio_track||!B||!e(B);if(F&&B&&B.sender){var z=!!B.sender.track;try{B.sender.replaceTrack(null)}catch(we){}v=!0,z&&(y=!0)}F&&(x.audio_mid=null,y=!0)}}for(var J in c.list_sending_live_mediastream){var V=c.list_sending_live_mediastream[J];if(!V.video_mid&&V.video_track)for(var H=0;H<u.length;H++){var G=u[H];if(G&&G.sender&&G.sender.track===V.video_track&&"video"===n(G)&&"string"==typeof G.mid&&G.mid.length){V.video_mid=G.mid,y=!0;break}}if(!V.audio_mid&&V.audio_track)for(var K=0;K<u.length;K++){var Q=u[K];if(Q&&Q.sender&&Q.sender.track===V.audio_track&&"audio"===n(Q)&&"string"==typeof Q.mid&&Q.mid.length){V.audio_mid=Q.mid,y=!0;break}}}function X(e){for(var n=[],i=0;i<e.length;i++)t(e[i])&&n.push(e[i]);return n}for(var Y=X(_),Z=X(f),ee=0;ee<l.length;ee++){var te=l[ee];if((I=c.list_sending_live_mediastream[te]).video_track&&null==I.video_mid&&Y.length){var ne=Y.shift(),ie=ne&&ne.sender?ne.sender.track:null;try{ne.sender.replaceTrack(I.video_track)}catch(ke){}ie!==I.video_track&&(y=!0),"string"==typeof ne.mid&&ne.mid.length&&I.video_mid!==ne.mid&&(I.video_mid=ne.mid,y=!0)}if(I.audio_track&&null==I.audio_mid&&Z.length){var re=Z.shift(),ae=re&&re.sender?re.sender.track:null;try{re.sender.replaceTrack(I.audio_track)}catch(Te){}ae!==I.audio_track&&(y=!0),"string"==typeof re.mid&&re.mid.length&&I.audio_mid!==re.mid&&(I.audio_mid=re.mid,y=!0)}}for(var oe in c.list_sending_live_mediastream)if(c.list_sending_live_mediastream.hasOwnProperty(oe)){var le=c.list_sending_live_mediastream[oe];if(le.video_mid&&le.video_track){var se=i(le.video_mid,"video");if(se&&se.sender&&"function"==typeof se.sender.getParameters&&"undefined"!=typeof window&&void 0!==window.document){var ce=se.sender,de=ce.getParameters()||{};de.encodings&&de.encodings.length||(de.encodings=[{}]);for(var _e=(0|le.max_video_bitrate)>0?0|le.max_video_bitrate:0,fe=(0|le.max_video_fps)>0?0|le.max_video_fps:0,ue=le.video_scale_down>1?le.video_scale_down:1,pe=[],he=0;he<de.encodings.length;he++){var ge={},me=de.encodings[he]||{};ge.active=!1!==me.active,_e&&(ge.maxBitrate=_e),fe&&(ge.maxFramerate=fe),ue&&1!==ue&&(ge.scaleResolutionDownBy=ue),pe.push(ge)}if((!r(de.encodings,pe)||de.degradationPreference!==(le.degradation||"balanced"))&&"function"==typeof ce.setParameters){de.encodings=pe,de.degradationPreference=le.degradation||"balanced";try{ce.setParameters(de)}catch(xe){console.log(xe)}try{"function"==typeof ce.requestKeyFrame&&ce.requestKeyFrame()}catch(Se){}}}}if(le.audio_mid&&le.audio_track)i(le.audio_mid,"audio")}y&&function(){var e={};for(var t in c.list_sending_live_mediastream)e[t]={video_mid:c.list_sending_live_mediastream[t].video_mid||null,audio_mid:c.list_sending_live_mediastream[t].audio_mid||null};c.seq_local_mediastream_map++;var n=JSON.stringify(e);j(13,p([16],[c.seq_local_mediastream_map,n]))}(),v&&null==c.remove_unused_tracks_timer&&(c.remove_unused_tracks_timer=setTimeout($,5e3))}}function G(e,t){e in c.list_sending_live_mediastream||(c.list_sending_live_mediastream[e]={video_track:null,audio_track:null,video_mid:null,audio_mid:null,mediastream_id:null,current_video_frame_height:0,current_video_frame_width:0,current_video_fps:0,current_video_mime_type:null,max_video_fps:0,max_video_bitrate:0,video_scale_down:1,audio_channel:1});var n=c.list_sending_live_mediastream[e],i=!1;if(t&&"object"==typeof t){if("video_track"in t){var r=n.video_track,a=t.video_track;(null==r!=(null==a)||r&&a&&0==S(r,a))&&(i=!0),n.video_track=a,null==a&&null!=n.video_mid&&(i=!0)}if("audio_track"in t){var o=n.audio_track,l=t.audio_track;(null==o!=(null==l)||o&&l&&0==S(o,l))&&(i=!0),n.audio_track=l,null==l&&null!=n.audio_mid&&(i=!0)}"mediastream_id"in t&&c.list_sending_live_mediastream[e].mediastream_id!==t.mediastream_id&&(c.list_sending_live_mediastream[e].mediastream_id=t.mediastream_id)}1==i&&c.pc&&H()}function K(){if(c.pc.localDescription&&c.pc.localDescription.type){var e=I(c.pc.localDescription.sdp);if(e&&e in c.list_gathered_local_candidates&&c.list_gathered_local_candidates[e].length>0)j(11,p([16],[c.list_gathered_local_candidates[e].length,e]))}}function Q(){for(var e=Date.now()-1e3;c.data_channel_sent_events.length&&c.data_channel_sent_events[0][0]<e;)c.data_channel_sent_events.shift();for(var t=c.data_channel_sent_events.length,n=0,i=0;i<t;i++)n+=c.data_channel_sent_events[i][1];return[t,n]}function X(){if(0==c.data_channel_sending_messages_paused&&null==c.data_channel_pump_queue_timer&&c.data_channel_sending_messages_queue.length>0){var[e,t]=Q(),n=0,i=Date.now();if(e>=c.data_channel_max_sending_messages_per_sec){var r=c.data_channel_sent_events[0][0];n=Math.max(n,1e3-(i-r))}if(t>=c.data_channel_max_sending_bytes_per_sec&&e>0){for(var a=t,l=0;l<e&&a>c.data_channel_max_sending_bytes_per_sec;)a-=c.data_channel_sent_events[l][1],l++;var s=1e3-(i-c.data_channel_sent_events[l-1>=0?l-1:0][0]);s>n&&(n=s)}if(n<0&&(n=0),n>60&&(n=60),n<=0)1==(null!==c.data_channel_primary_index&&c.list_data_channels[c.data_channel_primary_index]&&"open"==c.list_data_channels[c.data_channel_primary_index].readyState&&"open"==c.data_channel_state)?c.list_data_channels[c.data_channel_primary_index].bufferedAmount+c.data_channel_sending_messages_queue[0].data.length>c.data_channel_min_buffered_amount&&(n=10):n=20;c.data_channel_pump_queue_timer=setTimeout((function(){c.data_channel_pump_queue_timer=null,function(){var e=null!==c.data_channel_primary_index&&c.list_data_channels[c.data_channel_primary_index]&&"open"==c.list_data_channels[c.data_channel_primary_index].readyState&&"open"==c.data_channel_state;if(1==e&&c.list_data_channels[c.data_channel_primary_index].bufferedAmount<c.data_channel_max_buffered_amount){for(var t=[];c.data_channel_sending_messages_queue.length&&1==(e=null!==c.data_channel_primary_index&&c.list_data_channels[c.data_channel_primary_index]&&"open"==c.list_data_channels[c.data_channel_primary_index].readyState&&"open"==c.data_channel_state);){var n=c.data_channel_sending_messages_queue[0].data;if(c.list_data_channels[c.data_channel_primary_index].bufferedAmount+n.length>c.data_channel_min_buffered_amount)break;var[i,r]=Q();if(i>c.data_channel_max_sending_messages_per_sec||r>c.data_channel_max_sending_bytes_per_sec)break;try{var a=Date.now();c.list_data_channels[c.data_channel_primary_index].send(n),c.data_channel_sent_events.push([a,n.length]),null!==c.data_channel_sending_messages_queue[0].callback&&t.push(c.data_channel_sending_messages_queue[0].callback),c.data_channel_sending_messages_queue.shift()}catch(e){o.emit("error",e)}if(c.list_data_channels[c.data_channel_primary_index].bufferedAmount>=c.data_channel_max_buffered_amount)break}if(t.length>0)for(var l in t)t[l](!0)}c.data_channel_sending_messages_queue.length>0&&X()}()}),n)}}function Y(e,t){Z(p([8],[0,e]),t)}function Z(e,t){if("string"==typeof e&&(e=(new TextEncoder).encode(e)),c.pc&&c.pc.sctp){var n=900;"maxMessageSize"in c.pc.sctp&&c.pc.sctp.maxMessageSize>0&&(n=c.pc.sctp.maxMessageSize),n>=e.length?("function"==typeof t?c.data_channel_sending_messages_queue.push({data:e,callback:t}):c.data_channel_sending_messages_queue.push({data:e,callback:null}),X()):("function"==typeof t&&t(!1),o.emit("error","message must be less then "+n+" bytes"))}else o.emit("error","no sctp yet")}function ee(){if(clearTimeout(c.create_data_channel_timer),c.create_data_channel_timer=null,clearTimeout(c.create_offer_timer),c.create_offer_timer=null,clearTimeout(c.wait_for_answer_timeout_timer),c.wait_for_answer_timeout_timer=null,clearTimeout(c.negotiation_done_timeout_timer),c.negotiation_done_timeout_timer=null,clearTimeout(c.getstats_timer),c.getstats_timer=null,clearTimeout(c.data_channel_pump_queue_timer),c.data_channel_pump_queue_timer=null,clearTimeout(c.remove_unused_tracks_timer),c.remove_unused_tracks_timer=null,c.pc){for(var e in c.pc.sctp&&(c.pc.sctp.onstatechange=null,c.pc.sctp.transport&&(c.pc.sctp.transport.onstatechange=null,c.pc.sctp.transport.iceTransport&&(c.pc.sctp.transport.iceTransport.onstatechange=null))),c.list_data_channels)if(c.list_data_channels[e]&&null!==c.list_data_channels[e]&&(c.list_data_channels[e].onopen=null,c.list_data_channels[e].onclosing=null,c.list_data_channels[e].onclose=null,c.list_data_channels[e].onbufferedamountlow=null,"open"==c.list_data_channels[e].readyState||"connected"!==c.list_data_channels[e].readyState||"connecting"!==c.list_data_channels[e].readyState))try{"function"==typeof c.list_data_channels[e].close&&c.list_data_channels[e].close()}catch(e){}if(c.pc.ondatachannel=null,c.pc.onicecandidate=null,c.pc.onicecandidateerror=null,c.pc.onconnectionstatechange=null,c.pc.oniceconnectionstatechange=null,c.pc.onicegatheringstatechange=null,c.pc.onnegotiationneeded=null,c.pc.onsignalingstatechange=null,c.pc.ontrack=null,"function"==typeof c.pc.close&&"closed"!==c.pc.connectionState)try{c.pc.close()}catch(e){o.emit("error",e)}c.pc=null,o.emit("close")}}function te(e){"iceServers"in e&&e.iceServers.length>0?c.pc_config.iceServers=e.iceServers:c.pc_config.iceServers=[{urls:["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302","stun:stun.stunprotocol.org:3478","stun:global.stun.twilio.com:3478"]}],"certificates"in e&&(c.pc_config.certificates=e.certificates),c.pc_config.iceCandidatePoolSize="iceCandidatePoolSize"in e?e.iceCandidatePoolSize:1,c.pc_config.bundlePolicy="bundlePolicy"in e?e.bundlePolicy:"max-bundle",c.pc_config.rtcpMuxPolicy="rtcpMuxPolicy"in e?e.rtcpMuxPolicy:"require",c.pc_config.sdpSemantics="sdpSemantics"in e?e.sdpSemantics:"unified-plan","portRange"in e&&(c.pc_config.portRange=e.portRange),c.pc&&c.pc.setConfiguration(c.pc_config)}"object"==typeof t&&te(t),B((function(e,t){!e&&t&&"certificates"in c.pc_config==0&&(c.pc_config.certificates=[t]);try{if(c.pc=new RTCPeerConnection(c.pc_config),c.pc.onicecandidate=function(e){if(c.pc)if(null==e.candidate||e.candidate&&"usernameFragment"in e.candidate&&e.candidate.usernameFragment.length<=0)K();else{if(null==c.local_support_trickle_ice&&(c.local_support_trickle_ice=!0),"toJSON"in e.candidate&&"function"==typeof e.candidate.toJSON)var t=e.candidate.toJSON();else t=e.candidate;"host"!==e.candidate.type&&function(e){if(e.candidate&&e.candidate.length>0)try{var t=P(e.candidate);null==t.ufrag&&"usernameFragment"in e&&(t.ufrag=e.usernameFragment),j(10,v(t,e.sdpMid,e.sdpMLineIndex,e.ufrag))}catch(t){j(9,(new TextEncoder).encode(JSON.stringify(e)))}}(t);var n="default";if("usernameFragment"in t&&t.usernameFragment.length>0)n=t.usernameFragment;else{var i=P(t.candidate);"ufrag"in i&&i.ufrag.length>0&&(n=i.ufrag)}n in c.list_gathered_local_candidates==0&&(c.list_gathered_local_candidates[n]=[]),c.list_gathered_local_candidates[n].push(e.candidate),function(){if(c.pc.localDescription&&c.pc.localDescription.type){var e=I(c.pc.localDescription.sdp);if(e){var t=c.list_gathered_local_candidates[e],n=[],i=[],r=[],a=[],o=!1,l=!1,s=!1,d=!1,_=!1,f=!1,u=new Map;for(var p in t){var h=t[p];if(h){var g=h.candidate||"",m=h.address||"",v=void 0!==h.port&&null!==h.port?Number(h.port):0,y=h.relatedAddress||"",b=void 0!==h.relatedPort&&null!==h.relatedPort?Number(h.relatedPort):0,w=(h.protocol||"").toLowerCase(),k=h.type||"";if(!m||!v)try{var T=g.split(" ");T.length>6&&(m||(m=T[4]),v||(v=0|Number(T[5])));for(var x=0;x<T.length-1;x++)"raddr"!==T[x]||y||(y=T[x+1]),"rport"!==T[x]||b||(b=0|Number(T[x+1])),"typ"===T[x]&&!k&&x+1<T.length&&(k=T[x+1])}catch(e){}if(m&&(m=C(m)),y&&(y=C(y)),"udp"===w&&(o=!0),"tcp"===w&&(l=!0),"host"===k?s=!0:"srflx"===k?d=!0:"prflx"===k?_=!0:"relay"===k&&(f=!0),M(m)&&("relay"===k?D(m)?-1===r.indexOf(m)&&r.push(m):-1===a.indexOf(m)&&a.push(m):D(m)?-1===n.indexOf(m)&&n.push(m):-1===i.indexOf(m)&&i.push(m)),M(y)&&"relay"!==k&&(D(y)?-1===n.indexOf(y)&&n.push(y):-1===i.indexOf(y)&&i.push(y)),"srflx"===k||"prflx"===k){var S="";y&&b?S=y+"("+b+")":m&&v&&(S=m+"("+v+")");var R="";m&&v&&(R=m+"("+v+")"),S&&R&&(u.has(S)||u.set(S,new Set),u.get(S).add(R))}}}var A="unknown";!f||d||_||s||(A="relay-only"),"unknown"===A&&!o&&l&&(A="no-udp");for(var P=!1,O=!1,N=u.values(),U=N.next?N.next():{done:!0};!U.done;){var L=U.value;L&&L.size>1&&(P=!0),L&&1===L.size&&(O=!0),U=N.next()}"unknown"===A&&(P?A="symmetric":O&&(A="cone-like")),c.local_public_ipv4=i,c.local_public_ipv6=n,c.local_relay_ipv4=a,c.local_relay_ipv6=r,c.local_support_udp=o,c.local_support_tcp=l,c.local_nat_type=A}}}()}},c.pc.onicecandidateerror=function(e){e.errorCode>=300&&e.errorCode<=699||e.errorCode>=700&&e.errorCode},c.pc.oniceconnectionstatechange=function(){c.pc&&"closed"==c.pc.iceConnectionState&&ee()},c.pc.onconnectionstatechange=function(){c.pc&&"closed"==c.pc.connectionState&&ee()},c.pc.onicegatheringstatechange=function(e){c.pc&&"closed"!==c.pc.connectionState&&c.pc.iceGatheringState&&null!==c.pc.iceGatheringState&&"complete"==c.pc.iceGatheringState&&K()},c.pc.onnegotiationneeded=function(){},c.pc.onsignalingstatechange=function(){g({signaling_state:String(c.pc.signalingState)+""})},c.pc.ondatachannel=function(e){m(e.channel)},c.pc.ontrack=function(e){},g({signaling_state:String(c.pc.signalingState)+""}),null!==c.pending_remote_offer_sdp&&"stable"==c.signaling_state&&0==c.negotiation_state)E();else{var n=8+Math.floor(55*Math.random());c.create_data_channel_timer=setTimeout((function(){c.create_data_channel_timer=null,c.pc&&"closed"!==c.pc.connectionState&&null==c.pc.sctp&&function(){if(c.pc&&"closed"!==c.pc.connectionState)try{m(c.pc.createDataChannel("dc",{reliable:!1,maxRetransmits:0,ordered:!1,maxMessageSize:16384})),u()}catch(e){o.emit("error",e)}}()}),n)}}catch(e){o.emit("error",e),o.emit("close")}}));var ne={connection:c,on:function(e,t){o.on(e,t)},signal:function(e){var t=h([32],e);if(t[0]==k(t[1])){var n=h([16,16,8],t[1]);0==c.remote_nonce&&n[0]>0&&(c.remote_nonce=n[0]),n[0]!=c.remote_nonce||(0!=n[1]||c.pc&&c.pc.sctp&&c.pc.sctp.maxChannels&&c.pc.sctp.maxMessageSize&&!c.pc.sctp.maxMessageSize!=1/0)&&n[1]!=c.local_nonce||z(n[2],n[3])}},stream:function(e,t){G(e,t)},addStream:function(e,t){if(e&&T(e)){var n=null;"id"in e&&e.id.length>0&&(n=e.id);var i=n;for(var r in c.list_sending_live_mediastream)if(null!==c.list_sending_live_mediastream[r].mediastream_id&&c.list_sending_live_mediastream[r].mediastream_id==n){i=r;break}var a=null,o=null,l=e.getTracks();for(var s in l)null==a&&"video"==l[s].kind&&(a=l[s]),null==o&&"audio"==l[s].kind&&(o=l[s]);G(i,{video_track:a,audio_track:o})}},removeStream:function(e){if(e&&T(e)){var t=null;for(var n in"id"in e&&e.id.length>0&&(t=e.id),c.list_sending_live_mediastream)if(null!==c.list_sending_live_mediastream[n].mediastream_id&&c.list_sending_live_mediastream[n].mediastream_id==t){G(n,{video_track:null,audio_track:null});break}}},addTrack:function(e,t,n){if(t&&T(t)){var i=null;"id"in t&&t.id.length>0&&(i=t.id);var r=i;for(var a in c.list_sending_live_mediastream)if(null!==c.list_sending_live_mediastream[a].mediastream_id&&c.list_sending_live_mediastream[a].mediastream_id==i){r=a;break}e&&x(e)&&"kind"in e&&("audio"==e.kind?G(r,{audio_track:e}):"video"==e.kind&&G(r,{video_track:e}))}},removeTrack:function(e,t){var n=null;if(t&&T(t)&&"id"in t&&t.id.length>0&&(n=t.id),e&&x(e))for(var i in c.list_sending_live_mediastream)if(null!==n){if(null!==c.list_sending_live_mediastream[i].mediastream_id&&c.list_sending_live_mediastream[i].mediastream_id==n){"kind"in e&&("audio"==e.kind?G(i,{audio_track:null}):"video"==e.kind&&G(i,{video_track:null}));break}}else null!==list_sending_live_mediastream[i].video_track&&1==S(e,list_sending_live_mediastream[i].video_track)&&G(i,{video_track:null}),null!==list_sending_live_mediastream[i].audio_track&&1==S(e,list_sending_live_mediastream[i].audio_track)&&G(i,{audio_track:null})},send:Y,write:Y,set_auth_verified:function(e){1==e&&(c.auth_verified=!0)},setConfiguration:te,restartIce:function(){0==c.need_ice_restart&&(c.need_ice_restart=!0,u())},close:ee,destroy:ee};for(var ie in ne)Object.prototype.hasOwnProperty.call(ne,ie)&&(this[ie]=ne[ie]);return this}}));